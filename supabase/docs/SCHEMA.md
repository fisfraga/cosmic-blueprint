# Database Schema — Cosmic Blueprint
**Generated by:** @data-engineer (Dara) — Brownfield Discovery Phase 2
**Date:** 2026-02-20
**Workflow:** brownfield-discovery v2.0
**Supabase Project:** ykuhdxrttxzualqysgtr.supabase.co

---

## Overview

Cosmic Blueprint uses **Supabase** (PostgreSQL + Auth + RLS) as an optional cloud sync layer. The app is fully functional without a database connection — Supabase provides persistence and multi-device sync only when configured.

| Attribute | Value |
|-----------|-------|
| DB Engine | PostgreSQL (via Supabase) |
| Auth | Supabase Auth (magic link / OTP) |
| RLS | Enabled on all 4 tables |
| Migrations | 3 files (`supabase/migrations/`) |
| ORM | None — direct Supabase JS client |
| Schema | `public` (default) |

---

## Tables

### 1. `public.saved_insights`
*Migrations: 001_initial_schema.sql, 007_add_profile_id.sql*

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| `id` | TEXT | NOT NULL | — | Primary key (app-generated) |
| `user_id` | UUID | NOT NULL | — | FK → `auth.users(id)` ON DELETE CASCADE |
| `profile_id` | TEXT | NULL | — | Active profile ID for multi-profile isolation (added 007) |
| `content` | TEXT | NOT NULL | — | Insight body text |
| `category` | TEXT | NOT NULL | — | Contemplation category |
| `contemplation_type` | TEXT | NOT NULL | — | Specific contemplation type |
| `tags` | TEXT[] | NOT NULL | `'{}'` | Tag array |
| `session_id` | TEXT | NULL | — | Optional session reference (no FK) |
| `focus_entity` | TEXT | NULL | — | Entity ID string |
| `created_at` | TIMESTAMPTZ | NOT NULL | `NOW()` | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `NOW()` | Auto-updated via trigger |

**Indexes:**
- `idx_saved_insights_user_id` ON `(user_id)`
- `idx_saved_insights_created_at` ON `(user_id, created_at DESC)`
- `idx_saved_insights_profile_id` ON `(profile_id)` (added 007)

**RLS Policies:**
- `SELECT`: `auth.uid() = user_id`
- `INSERT`: `auth.uid() = user_id`
- `UPDATE`: `auth.uid() = user_id`
- `DELETE`: `auth.uid() = user_id`

**Trigger:** `handle_saved_insights_updated_at` → `handle_updated_at()` BEFORE UPDATE

---

### 2. `public.cosmic_profiles`
*Migration: 001_initial_schema.sql*

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| `id` | TEXT | NOT NULL | — | Primary key (app-generated slug) |
| `user_id` | UUID | NOT NULL | — | FK → `auth.users(id)` ON DELETE CASCADE |
| `name` | TEXT | NOT NULL | — | Profile display name |
| `profile_data` | JSONB | NOT NULL | — | Full CosmicProfile v2 JSON |
| `is_active` | BOOLEAN | NOT NULL | `FALSE` | Active profile flag |
| `created_at` | TIMESTAMPTZ | NOT NULL | `NOW()` | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `NOW()` | Auto-updated via trigger |

**Indexes:**
- `idx_cosmic_profiles_user_id` ON `(user_id)`
- `idx_cosmic_profiles_active_user` UNIQUE ON `(user_id)` WHERE `is_active = TRUE`

**RLS Policies:**
- `SELECT`: `auth.uid() = user_id`
- `INSERT`: `auth.uid() = user_id`
- `UPDATE`: `auth.uid() = user_id`
- `DELETE`: `auth.uid() = user_id`

**Trigger:** `handle_cosmic_profiles_updated_at` → `handle_updated_at()` BEFORE UPDATE

---

### 3. `public.pathway_progress`
*Migration: 002_pathway_progress.sql*

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| `id` | TEXT | NOT NULL | — | Primary key |
| `user_id` | UUID | NOT NULL | — | FK → `auth.users(id)` ON DELETE CASCADE |
| `pathway_id` | TEXT | NOT NULL | — | Pathway identifier |
| `current_step_index` | INTEGER | NOT NULL | `0` | Current step position |
| `completed_steps` | TEXT[] | NOT NULL | `'{}'` | Array of completed step IDs |
| `journal_entries` | JSONB | NOT NULL | `'{}'` | Step-keyed journal data |
| `started_at` | TIMESTAMPTZ | NOT NULL | — | When journey began |
| `last_activity_at` | TIMESTAMPTZ | NOT NULL | — | Last interaction |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `NOW()` | Auto-updated via trigger |

**Indexes:**
- `idx_pathway_progress_user_id` ON `(user_id)`
- `idx_pathway_progress_user_pathway` UNIQUE ON `(user_id, pathway_id)`

**RLS Policies:**
- `SELECT`: `auth.uid() = user_id`
- `INSERT`: `auth.uid() = user_id`
- `UPDATE`: `auth.uid() = user_id`
- `DELETE`: `auth.uid() = user_id`

**Trigger:** `handle_pathway_progress_updated_at` → `handle_updated_at()` BEFORE UPDATE

---

### 4. `contemplation_sessions` ⚠️
*Migrations: 003_contemplation_sessions.sql, 007_add_profile_id.sql*

> **Note:** This table is created **without `public.` schema prefix** in migration 003, unlike the other 3 tables. It defaults to `public` schema in PostgreSQL/Supabase, but represents a naming inconsistency.

| Column | Type | Nullable | Default | Notes |
|--------|------|----------|---------|-------|
| `id` | TEXT | NOT NULL | — | Primary key |
| `user_id` | UUID | NOT NULL | — | FK → `auth.users(id)` ON DELETE CASCADE |
| `profile_id` | TEXT | NULL | — | Active profile ID for multi-profile isolation (added 007) |
| `category` | TEXT | NOT NULL | — | Contemplation category |
| `contemplation_type` | TEXT | NOT NULL | — | Specific type |
| `focus_entity` | JSONB | NULL | — | Full entity object (not just ID) |
| `messages` | JSONB | NOT NULL | `'[]'` | Full conversation history array |
| `created_at` | TIMESTAMPTZ | NOT NULL | `NOW()` | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | NOT NULL | `NOW()` | Auto-updated via trigger |

**Indexes:**
- `idx_contemplation_sessions_user_id` ON `(user_id)`
- `idx_contemplation_sessions_updated_at` ON `(user_id, updated_at DESC)`
- `idx_contemplation_sessions_profile_id` ON `(profile_id)` (added 007)

**RLS Policies:**
- `SELECT`: `auth.uid() = user_id`
- `INSERT`: `auth.uid() = user_id`
- `UPDATE`: `auth.uid() = user_id`
- `DELETE`: `auth.uid() = user_id`

**Trigger:** `handle_contemplation_sessions_updated_at` → `handle_updated_at()` BEFORE UPDATE

---

## Functions

### `public.handle_updated_at()`
*Migration: 001_initial_schema.sql*

```sql
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

Used by all 4 table triggers for automatic timestamp management.

---

## Entity Relationship Diagram

```
auth.users (Supabase managed)
    │
    ├─── public.saved_insights (user_id FK, CASCADE DELETE)
    │         id: TEXT PK
    │         content, category, contemplation_type: TEXT
    │         tags: TEXT[]
    │         session_id: TEXT (no FK)
    │         focus_entity: TEXT (entity ID string)
    │
    ├─── public.cosmic_profiles (user_id FK, CASCADE DELETE)
    │         id: TEXT PK
    │         name: TEXT
    │         profile_data: JSONB (full CosmicProfile)
    │         is_active: BOOLEAN (unique partial index)
    │
    ├─── public.pathway_progress (user_id FK, CASCADE DELETE)
    │         id: TEXT PK
    │         pathway_id: TEXT
    │         current_step_index, completed_steps, journal_entries
    │         UNIQUE(user_id, pathway_id)
    │
    └─── contemplation_sessions (user_id FK, CASCADE DELETE)
              id: TEXT PK
              category, contemplation_type: TEXT
              focus_entity: JSONB
              messages: JSONB []
```

---

## Authentication

| Method | Status | Notes |
|--------|--------|-------|
| Magic Link (Email OTP) | ✅ Active | Primary method |
| Google OAuth | ❌ Not configured | — |
| GitHub OAuth | ❌ Not configured | — |
| Password | ❌ Not configured | By design (passwordless) |

**Session handling:** Supabase manages JWT tokens. App uses `onAuthStateChange()` listener in `AuthContext.tsx`.

---

## Migration Sequence

| # | File | Tables Affected | Dependencies |
|---|------|----------------|-------------|
| 001 | `001_initial_schema.sql` | `saved_insights`, `cosmic_profiles` | None |
| 002 | `002_pathway_progress.sql` | `pathway_progress` | 001 (handle_updated_at function) |
| 003 | `003_contemplation_sessions.sql` | `contemplation_sessions` | 001 (handle_updated_at function) |
