# Database Audit — Cosmic Blueprint
**Generated by:** @data-engineer (Dara) — Brownfield Discovery Phase 2
**Date:** 2026-02-20
**Workflow:** brownfield-discovery v2.0

---

## Audit Summary

| Category | Issues Found | Critical | High | Medium | Low |
|----------|-------------|----------|------|--------|-----|
| Schema Design | 6 | 0 | 1 | 4 | 1 |
| Indexes & Performance | 4 | 0 | 2 | 2 | 0 |
| Security (RLS) | 3 | 0 | 0 | 2 | 1 |
| Data Integrity | 3 | 0 | 1 | 2 | 0 |
| Authentication | 2 | 0 | 0 | 1 | 1 |
| Operations | 2 | 0 | 1 | 1 | 0 |
| **TOTAL** | **20** | **0** | **5** | **12** | **3** |

---

## Detailed Findings

### Schema Design

---

#### DB-SD-01 — Missing `public.` prefix on `contemplation_sessions`
**Severity:** LOW
**Migration:** 003_contemplation_sessions.sql

**Issue:** The `contemplation_sessions` table is created without the `public.` schema prefix, unlike all other 3 tables which explicitly use `public.`:

```sql
-- Migration 001 (correct):
CREATE TABLE IF NOT EXISTS public.saved_insights (...)

-- Migration 003 (inconsistent):
CREATE TABLE IF NOT EXISTS contemplation_sessions (...)
```

**Impact:** In PostgreSQL, the default schema is `public`, so this likely works in practice. However, it is inconsistent and could cause issues with explicit schema-qualified queries, Supabase dashboard display, or RLS rule application in certain configurations.

**Recommendation:** Add `public.` prefix in migration 003 for consistency. Create a migration 004 that renames/recreates with proper prefix if needed.

---

#### DB-SD-02 — `profile_data` stored as unversioned JSONB
**Severity:** MEDIUM
**Table:** `public.cosmic_profiles`

**Issue:** The entire `CosmicProfile` object (complex nested structure with astrology, HD, GK data) is stored as a single JSONB column with no version field. The app has a `profileMigration.ts` service (v1→v2 migration) but the DB has no equivalent schema evolution mechanism.

**Impact:** If the `CosmicProfile` TypeScript type changes between sprints, previously stored profiles may fail to deserialize correctly. There is no way to query by profile schema version or identify which profiles need migration.

**Recommendation:**
1. Add a `schema_version` column to `cosmic_profiles` (TEXT or INTEGER, default `'2.0'`)
2. Store the calculation version from `chartCalculation.ts` (currently `CALCULATION_VERSION = '1.0.0'`)
3. Run a migration that sets the version on all existing rows

---

#### DB-SD-03 — `session_id` in `saved_insights` has no Foreign Key
**Severity:** MEDIUM
**Table:** `public.saved_insights`

**Issue:** `saved_insights.session_id` references a contemplation session but has no FK constraint to `contemplation_sessions.id`. This means:
- Orphaned insights can exist if a session is deleted
- No cascade behavior — sessions can be deleted leaving dangling `session_id` references

**Recommendation:** Add FK: `session_id TEXT REFERENCES contemplation_sessions(id) ON DELETE SET NULL`

---

#### DB-SD-04 — `focus_entity` inconsistency: TEXT in `saved_insights` vs JSONB in `contemplation_sessions`
**Severity:** MEDIUM
**Tables:** `saved_insights`, `contemplation_sessions`

**Issue:** The same concept ("focus entity") is stored differently:
- `saved_insights.focus_entity` → TEXT (entity ID string only)
- `contemplation_sessions.focus_entity` → JSONB (full entity object)

This makes cross-table queries on focus entity impossible without type coercion.

**Recommendation:** Standardize to TEXT (entity ID) in both tables. The full entity object can be looked up from the knowledge base at query time.

---

#### DB-SD-05 — `messages` in `contemplation_sessions` as monolithic JSONB array
**Severity:** MEDIUM
**Table:** `contemplation_sessions`

**Issue:** The full conversation history (`messages: JSONB NOT NULL DEFAULT '[]'`) is stored as a single unbounded array. As conversations grow:
- No pagination possible on message history
- Full array must be fetched even for metadata queries
- No way to search within message content
- PostgreSQL JSONB arrays have no practical size limit but performance degrades with large arrays

**Recommendation:** Consider a separate `session_messages` table with proper FK:
```sql
CREATE TABLE session_messages (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL REFERENCES contemplation_sessions(id) ON DELETE CASCADE,
  role TEXT NOT NULL, -- 'user' | 'assistant'
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```
This enables pagination, search, and efficient metadata queries.

---

#### DB-SD-06 — No `profile_id` FK in `saved_insights` or `contemplation_sessions`
**Severity:** HIGH
**Tables:** `saved_insights`, `contemplation_sessions`

**Issue:** Both tables record contemplation activity but have no reference to which `cosmic_profile` was active when the activity occurred. If a user switches profiles, there is no way to associate historical insights/sessions with the profile that generated them.

**Impact:** For users with multiple profiles (up to 10 are allowed), all insights/sessions appear together regardless of which profile was active. This creates a confusing UX and makes profile-specific filtering impossible at the DB level.

**Recommendation:** Add `profile_id TEXT REFERENCES cosmic_profiles(id) ON DELETE SET NULL` to both tables.

---

### Indexes & Performance

---

#### DB-IDX-01 — Missing index on `saved_insights(category, contemplation_type)`
**Severity:** HIGH
**Table:** `saved_insights`

**Issue:** The `InsightLibrary` page filters insights by `category` and `contemplation_type`. With no index on these columns, all filtering happens in-memory in the app after fetching all insights for the user. As insight volume grows, this becomes expensive.

**Recommendation:**
```sql
CREATE INDEX idx_saved_insights_category
  ON public.saved_insights(user_id, category, created_at DESC);

CREATE INDEX idx_saved_insights_type
  ON public.saved_insights(user_id, contemplation_type, created_at DESC);
```

---

#### DB-IDX-02 — No full-text search support on insights
**Severity:** HIGH
**Table:** `saved_insights`

**Issue:** The `InsightLibrary` has a search interface. With no `tsvector` index, search is done client-side (all insights loaded, filtered in memory). At scale (100s of insights), this is expensive.

**Recommendation:**
```sql
ALTER TABLE public.saved_insights
  ADD COLUMN fts tsvector
  GENERATED ALWAYS AS (to_tsvector('english', content)) STORED;

CREATE INDEX idx_saved_insights_fts
  ON public.saved_insights USING GIN(fts);
```

---

#### DB-IDX-03 — `pathway_progress` lacks standalone `pathway_id` index
**Severity:** MEDIUM
**Table:** `pathway_progress`

**Issue:** There is a compound unique index on `(user_id, pathway_id)` but no standalone index on `pathway_id`. If queries are made by pathway across all users (e.g., "how many users are on pathway X"), no efficient index exists.

**Impact:** Low for current single-user access patterns, but could matter for analytics.

**Recommendation:** Add `CREATE INDEX idx_pathway_progress_pathway_id ON public.pathway_progress(pathway_id)` — low priority.

---

#### DB-IDX-04 — No index on `contemplation_sessions(category, contemplation_type)`
**Severity:** MEDIUM
**Table:** `contemplation_sessions`

**Issue:** Sessions page (`SessionsLibrary`) likely filters by category/type. Same issue as insights — no index means full table scan per user.

**Recommendation:**
```sql
CREATE INDEX idx_contemplation_sessions_category
  ON contemplation_sessions(user_id, category, updated_at DESC);
```

---

### Security (RLS)

---

#### DB-SEC-01 — No `public.` prefix on RLS policies for `contemplation_sessions`
**Severity:** LOW
**Table:** `contemplation_sessions`

**Issue:** RLS policies in migration 003 reference the table without `public.` prefix. While this works, it is inconsistent with other tables and could cause confusion.

---

#### DB-SEC-02 — `tags` array in `saved_insights` has no validation
**Severity:** MEDIUM
**Table:** `saved_insights`

**Issue:** `tags TEXT[] NOT NULL DEFAULT '{}'` has no constraint on tag format, length, or count. A malicious or buggy client could insert:
- Extremely long tags (no length limit)
- Thousands of tags (no count limit)
- Tags with special characters that could cause display issues

**Recommendation:** Add a CHECK constraint:
```sql
ALTER TABLE public.saved_insights
  ADD CONSTRAINT check_tags_reasonable
  CHECK (array_length(tags, 1) IS NULL OR array_length(tags, 1) <= 50);
```

---

#### DB-SEC-03 — No rate limiting on API/DB level
**Severity:** MEDIUM

**Issue:** Supabase applies row-level security but has no rate limiting on insert operations. A user could theoretically insert thousands of insights in rapid succession, causing storage and cost issues.

**Recommendation:** Consider Supabase Edge Functions middleware or application-level throttling on sync operations.

---

### Data Integrity

---

#### DB-DI-01 — No CHECK constraints on `category` or `contemplation_type`
**Severity:** MEDIUM
**Tables:** `saved_insights`, `contemplation_sessions`

**Issue:** Both `category` and `contemplation_type` are free-form TEXT fields with no validation. Valid values are defined only in TypeScript (`ContemplationType` union in `context.ts`). Inconsistent values can be inserted from any client or direct API call.

**Recommendation:**
```sql
ALTER TABLE public.saved_insights
  ADD CONSTRAINT check_category
  CHECK (category IN ('astrology', 'humanDesign', 'geneKeys', 'crossSystem', 'lifeOS', 'alchemy'));
```
Or use an enum type for better enforceability.

---

#### DB-DI-02 — `TEXT` PRIMARY KEYS with no format validation
**Severity:** MEDIUM
**Tables:** All 4

**Issue:** All tables use TEXT PKs generated client-side. There is no format constraint (e.g., UUID format, slug format) ensuring uniqueness strategy is consistent.

**Impact:** In theory, two clients could generate the same ID (though unlikely given the generation strategy in `profiles.ts`). No server-side uniqueness guarantee beyond the PK constraint itself.

**Recommendation:** Consider migrating PKs to `UUID` with `gen_random_uuid()` default for true server-side guarantees, or add a CHECK constraint validating ID format.

---

#### DB-DI-03 — No `NOT NULL` on `pathway_progress.started_at` and `last_activity_at` application-enforced
**Severity:** HIGH
**Table:** `pathway_progress`

**Issue:** `started_at` and `last_activity_at` are NOT NULL but have no DEFAULT — they must be provided by the application. If the app sends NULL (e.g., a bug in `pathwaySync.ts`), the insert fails with a cryptic error. Other timestamp columns use `DEFAULT NOW()` which is safer.

**Recommendation:** Add `DEFAULT NOW()` to both columns for safer inserts:
```sql
ALTER TABLE public.pathway_progress
  ALTER COLUMN started_at SET DEFAULT NOW(),
  ALTER COLUMN last_activity_at SET DEFAULT NOW();
```

---

### Authentication

---

#### DB-AUTH-01 — Only magic link auth — no social login
**Severity:** MEDIUM

**Issue:** The app only supports passwordless magic link authentication. Users without reliable email access, or who prefer social login (Google, Apple) have no alternative. This limits onboarding conversion rates.

**Recommendation:** Enable Google OAuth in Supabase Auth settings. The `authService.ts` can be extended with `signInWithOAuth({ provider: 'google' })`.

---

#### DB-AUTH-02 — No email domain allowlist
**Severity:** LOW

**Issue:** Any email address can sign up. For a premium/controlled product, this may be intentional, but there is no mechanism for invite-only or domain-restricted access.

---

### Operations

---

#### DB-OPS-01 — No database backup/export strategy documented
**Severity:** HIGH

**Issue:** Supabase provides automatic backups on paid plans, but there is no documented:
- Backup frequency or retention policy
- User data export mechanism (GDPR/data portability)
- Disaster recovery procedure

**Recommendation:** Document the backup strategy. Add a data export feature (JSON download of all user insights/profiles) to comply with data portability requirements.

---

#### DB-OPS-02 — No database migration tooling configured
**Severity:** MEDIUM

**Issue:** Migrations are plain SQL files in `supabase/migrations/` but there is no Supabase CLI configuration (no `supabase/config.toml`). Migrations must be applied manually via the Supabase SQL editor.

**Impact:** No automated deployment of schema changes. Risk of dev/prod schema drift.

**Recommendation:**
```bash
# Initialize Supabase CLI
supabase init
supabase link --project-ref ykuhdxrttxzualqysgtr

# Then migrations can be applied via:
supabase db push
```

---

## Prioritized Remediation Plan

| Priority | ID | Debt | Effort | Severity |
|----------|----|------|--------|----------|
| 1 | DB-SD-06 | Add `profile_id` FK to insights + sessions | Medium | HIGH |
| 2 | DB-IDX-01 | Index on `saved_insights(category, type)` | Low | HIGH |
| 3 | DB-IDX-02 | Full-text search on insights | Medium | HIGH |
| 4 | DB-DI-03 | `DEFAULT NOW()` on pathway timestamps | Low | HIGH |
| 5 | DB-OPS-01 | Document backup + export strategy | Low | HIGH |
| 6 | DB-SD-02 | `schema_version` column on cosmic_profiles | Medium | MEDIUM |
| 7 | DB-SD-03 | FK from `session_id` to `contemplation_sessions` | Low | MEDIUM |
| 8 | DB-SD-04 | Standardize `focus_entity` type (TEXT vs JSONB) | Medium | MEDIUM |
| 9 | DB-SD-05 | Extract `session_messages` table | High | MEDIUM |
| 10 | DB-AUTH-01 | Add Google OAuth | Low | MEDIUM |
| 11 | DB-DI-01 | CHECK constraints on category/type | Low | MEDIUM |
| 12 | DB-IDX-03 | Standalone `pathway_id` index | Low | MEDIUM |
| 13 | DB-IDX-04 | Index on sessions(category) | Low | MEDIUM |
| 14 | DB-SEC-02 | Tags array CHECK constraint | Low | MEDIUM |
| 15 | DB-SEC-03 | Rate limiting strategy | Medium | MEDIUM |
| 16 | DB-OPS-02 | Supabase CLI config | Low | MEDIUM |
| 17 | DB-DI-02 | UUID primary keys | High | MEDIUM |
| 18 | DB-SD-01 | Fix `public.` prefix on sessions table | Low | LOW |
| 19 | DB-AUTH-02 | Email domain allowlist | Low | LOW |
| 20 | DB-SEC-01 | RLS policy naming consistency | Low | LOW |

---

## Estimated Hours

| Category | Low Estimate | High Estimate |
|----------|-------------|---------------|
| Schema fixes (SD-01, SD-02, SD-03, SD-04) | 3h | 6h |
| Session messages table (SD-05) | 8h | 16h |
| Profile ID FK + sync updates (SD-06) | 6h | 12h |
| Indexes (IDX-01 through IDX-04) | 2h | 4h |
| Auth (Google OAuth) | 3h | 6h |
| Data integrity constraints | 2h | 3h |
| Operations (CLI, backup, export) | 4h | 8h |
| **TOTAL** | **28h** | **55h** |

---

*Document Version: 1.0 — Phase 2 of 10 (Brownfield Discovery)*
*Next: Phase 3 (@ux-design-expert) → Phase 4 (Consolidation)*
