# Frontend Specification ‚Äî Cosmic Blueprint
**Generated by:** @ux-design-expert (Uma) ‚Äî Brownfield Discovery Phase 3
**Date:** 2026-02-20
**Workflow:** brownfield-discovery v2.0
**Status:** Phase 3 Complete ‚Äî Comprehensive UX/UI & Design Systems Audit

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Codebase Metrics](#2-codebase-metrics)
3. [Component Inventory](#3-component-inventory)
4. [Pattern Audit: Buttons](#4-pattern-audit-buttons)
5. [Pattern Audit: Forms](#5-pattern-audit-forms)
6. [Pattern Audit: Typography](#6-pattern-audit-typography)
7. [Pattern Audit: Colors & Theming](#7-pattern-audit-colors--theming)
8. [Pattern Audit: Layout & Spacing](#8-pattern-audit-layout--spacing)
9. [Pattern Audit: Motion & Animation](#9-pattern-audit-motion--animation)
10. [Routing Architecture](#10-routing-architecture)
11. [State Management](#11-state-management)
12. [Accessibility Audit (WCAG)](#12-accessibility-audit-wcag)
13. [Error Handling & Resilience](#13-error-handling--resilience)
14. [Redundancy Analysis & Metrics](#14-redundancy-analysis--metrics)
15. [Systems Design Principles](#15-systems-design-principles)
16. [Design System Roadmap](#16-design-system-roadmap)
17. [Questions for Phase 4+ Review](#17-questions-for-phase-4-review)

---

## 1. Executive Summary

### The Good News

Cosmic Blueprint is a **remarkably well-structured codebase** for a product built through rapid sprint iterations. It demonstrates:

- **Professional-grade Tailwind discipline** ‚Äî 0 inline styles, 1 arbitrary value (`bg-[#9333EA]`), centralized color utilities
- **Clean TypeScript architecture** ‚Äî strict mode, 30+ discriminated entity types, consistent patterns
- **Smart lazy loading** ‚Äî all 79 routes lazy-loaded with Suspense fallback
- **Coherent visual identity** ‚Äî element-based theming (fire/earth/air/water) + tradition-specific palettes (humandesign/genekey)
- **Local-first resilience** ‚Äî works fully offline, Supabase optional

### The Honest Truth

The codebase has grown organically through 10+ sprints without a formalized design system. This creates:

- **366 ad-hoc button instances** with ~6 implicit variants ‚Äî no shared Button component
- **16+ form inputs** across 4 forms ‚Äî no shared Input/Select/Textarea components
- **5 D3 visualizations** with zero shared utilities ‚Äî each reimplements SVG setup, color maps, interactions
- **2 god components** (ContemplationChamber 1,345L, EntityDetailPanel 1,215L)
- **Entity routing logic duplicated** in 3+ separate files
- **49 aria attributes total** across 105 files ‚Äî accessibility is sparse

### Redundancy Score

| Pattern | Unique | Instances | Redundancy Factor | Assessment |
|---------|--------|-----------|-------------------|------------|
| Buttons | 6 variants | 366 instances | 61.0x | **CRITICAL** ‚Äî No component |
| Colors | 8 scales | 761 custom uses | 1.0x | **EXCELLENT** ‚Äî Centralized |
| Typography | 9 sizes | 2,248 instances | 1.0x | **GOOD** ‚Äî Tailwind scale |
| Forms | 4 forms | 16+ inputs | N/A | **NEEDS WORK** ‚Äî No primitives |
| D3 Visualizations | 5 components | 5 unique | 5.0x shared code | **MEDIUM** ‚Äî No shared utils |

### Phase 3 Verdict

**The styling is disciplined. The component architecture needs formalization.**

The app doesn't need a component library overhaul ‚Äî it needs **5-8 atomic components** extracted from existing patterns to eliminate redundancy and enable consistent evolution. This is a brownfield success story: the patterns ARE there, they just aren't extracted yet.

---

## 2. Codebase Metrics

### File Inventory

| Category | Files | Lines | Average |
|----------|-------|-------|---------|
| Components | 28 | 8,459 | 302 L/file |
| Pages | 73 | 21,596 | 296 L/file |
| Services | 34 | ~8,500 | 250 L/file |
| Styles | 1 (globals.css) | 45 | ‚Äî |
| Color Utilities | 1 (colors.ts) | ~200 | ‚Äî |
| **Total Frontend** | **~140** | **~39,000** | ‚Äî |

### Dependency Footprint

| Library | Purpose | Status |
|---------|---------|--------|
| React 18.2.0 | UI framework | Active |
| React Router 6.20.0 | Routing | Active |
| Tailwind CSS 3.3.6 | Styling | Active (sole styling method) |
| Framer Motion 10.16.16 | Animations | Active (11 components) |
| D3.js 7.8.5 | Visualizations | Active (5 components) |
| Zustand 4.4.7 | State management | **DEAD** ‚Äî never imported |
| **External UI libraries** | ‚Äî | **NONE** |

### Key Architectural Facts

- **Zero CSS-in-JS** (no styled-components, emotion, CSS Modules)
- **Zero external component libraries** (no shadcn, radix, headlessui)
- **Dark-only theme** ‚Äî no `dark:` prefix classes, no light mode
- **Mobile-first responsive** ‚Äî `md:` and `lg:` breakpoints throughout
- **Unicode + inline SVG icons** ‚Äî no icon library

---

## 3. Component Inventory

### Reusability Tiers

#### Tier 1: Highly Reusable (used 10+ times)

| Component | Lines | Variants | Used In |
|-----------|-------|----------|---------|
| EntityCard | 241 | 3 (default, compact, full) | 20+ pages |
| LoadingSkeleton | 155 | 4 (page, cards, detail, profile) | All list/detail pages |
| FilterBar | 92 | Generic (TypeScript generics) | Element, aspect, status filters |
| NotFoundState | 109 | 3 exports (NotFound, Empty, ProfileRequired) | All error states |
| PageTransition | 66 | Animation configs (fadeInUp, stagger, scale) | 10+ pages |

#### Tier 2: Moderately Reusable (2-5 times)

| Component | Lines | Notes |
|-----------|-------|-------|
| BodyGraph + ProfileBodyGraph | 622 + 195 | HD visualization + context wrapper |
| EntityLink | 455 | Cross-system link rendering |
| MessageContent | 285 | Rich text with entity references |
| EntityPicker | 245 | Search/select entity |
| SearchBar | 306 | Global Cmd+K search |

#### Tier 3: Page-Specific (1 time)

| Component | Lines | Notes |
|-----------|-------|-------|
| ContemplationChamber (page) | 1,345 | AI chat UI ‚Äî god component |
| EntityDetailPanel | 1,215 | Slide-in panel ‚Äî god component |
| Layout | 707 | App shell + 7 nav menus |
| ProfileCreationForm | 624 | Birth data entry |
| ConstellationGraph | 568 | D3 force graph |
| HouseSubstanceWheel | 334 | D3 alchemy wheel |
| ChakraBodyViz | 327 | Chakra visualization |

### God Components (>800 lines)

| Component | Lines | Symptom | Root Cause |
|-----------|-------|---------|------------|
| ContemplationChamber.tsx | 1,345 | 19 useState, streaming chat, session management, pathway tracking | Multi-feature page never decomposed |
| EntityDetailPanel.tsx | 1,215 | 29+ entity types, ~200L of switch/if rendering | No entity type handler registry |
| Profile.tsx | 1,202 | Synthesis of 3 traditions + elemental analysis | Dashboard aggregation logic inline |

### D3 Visualization Components (shared code opportunity)

| Component | Lines | D3 Features Used |
|-----------|-------|-----------------|
| CelestialMandala | 230 | Arc segments, zodiac wheel |
| ConstellationGraph | 568 | Force simulation, node/link rendering |
| BodyGraph | 622 | Custom SVG paths, center rendering |
| HouseSubstanceWheel | 334 | Arc segments, substance mapping |
| ChakraBodyViz | 327 | Body silhouette, chakra positioning |

**Shared code that could be extracted:**
- SVG container setup + ref management (~20L per component)
- Element/entity color mappings (~15-30L per component, duplicated)
- Hover/click interaction handlers (~20L per component)
- Coordinate transformation utilities

---

## 4. Pattern Audit: Buttons

### Overview

| Metric | Value |
|--------|-------|
| Total button-like elements | 366 |
| Shared Button component | **NONE** |
| Implicit variants identified | 6 |
| Files with buttons | 40+ |

### Identified Implicit Variants

#### 1. Primary (Gradient CTA)
```
className="px-4 py-2 bg-gradient-to-r from-amber-600 to-purple-600
           hover:from-amber-500 hover:to-purple-500 text-white rounded-lg
           transition-all"
```
**Used in:** Onboarding CTAs, profile actions, contemplation submit
**Occurrences:** ~40

#### 2. Secondary (Flat Dark)
```
className="px-4 py-2 bg-neutral-800 text-neutral-300 rounded-lg
           hover:bg-neutral-700 transition-colors"
```
**Used in:** Cancel buttons, alternative actions, navigation
**Occurrences:** ~60

#### 3. Ghost (Text Only)
```
className="px-4 py-2 text-neutral-400 hover:text-white transition-colors"
```
**Used in:** Tertiary actions, back navigation, dismiss
**Occurrences:** ~30

#### 4. Pill (Filter/Tag)
```
className="px-4 py-2 rounded-full border text-sm font-medium transition-all"
```
**Used in:** FilterBar, entity type selectors, tag pills
**Occurrences:** ~80 (via FilterBar mostly)

#### 5. Icon (Square/Circular)
```
className="p-1 text-gray-400 hover:text-white transition-colors"
```
**Used in:** Close buttons, expand/collapse, navigation arrows
**Occurrences:** ~50

#### 6. Small/Tag (Compact)
```
className="px-2 py-0.5 text-xs rounded bg-neutral-700 text-gray-400
           hover:bg-neutral-600"
```
**Used in:** Inline tags, small action buttons, badges
**Occurrences:** ~40

### Redundancy Assessment

**Redundancy Factor: 61.0x** (366 instances / 6 variants)

Every button is styled inline. The same gradient string (`from-amber-600 to-purple-600`) appears in 40+ locations. A single change to the primary button style requires editing 40 files.

**Impact:** HIGH ‚Äî This is the single largest redundancy in the codebase.

---

## 5. Pattern Audit: Forms

### Overview

| Metric | Value |
|--------|-------|
| Total form containers | 4 major forms |
| Input elements | 16+ (7 text, 4 number, 2 date, 2 time, 1 email) |
| Select elements | 4+ |
| Textarea elements | 2+ |
| Shared form components | **NONE** |
| Form library | **NONE** (no React Hook Form, Formik) |

### Identified Forms

| Location | Purpose | Fields | Validation |
|----------|---------|--------|-----------|
| ProfileCreationForm.tsx | Birth data entry | 7 inputs + 2 selects + 2 textareas | Required + coordinate validation |
| Onboarding.tsx (StepBirthData) | Multi-step onboarding birth data | 6 inputs + 1 select | Required + coordinate validation |
| SearchBar.tsx | Global search | 1 text input | Keyboard nav + debounce |
| InsightSaveButton.tsx | Tag input | Dynamic tag system | Tag deduplication |
| ContemplationChamber.tsx | Chat input | 1 textarea | Submit on Enter |
| AuthModal.tsx | Email login | 1 email input | Required |

### Input Styling Pattern (Repeated)
```
className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700
           rounded-lg text-white placeholder-neutral-500
           focus:outline-none focus:border-purple-500"
```

This exact pattern (with minor variations) appears in every input across the codebase.

### Validation Pattern
```typescript
// Inline state-based validation (repeated per form)
const [errors, setErrors] = useState<Record<string, string>>({});
const handleSubmit = () => {
  const newErrors: Record<string, string> = {};
  if (!name) newErrors.name = 'Name is required';
  // ... more checks
  setErrors(newErrors);
};
```

### Duplication Between ProfileCreationForm and Onboarding

Both components implement nearly identical birth data forms:
- Same fields (name, date, time, location, coordinates, timezone)
- Same validation logic
- Same coordinate parsing
- Same timezone selection

**ProfileCreationForm.tsx** = 624 lines
**Onboarding StepBirthData** = ~200 lines within Onboarding.tsx (742L total)

~200 lines of duplicated form logic.

### Redundancy Assessment

**No redundancy factor calculable** (too few forms to measure statistically), but qualitative assessment: **MEDIUM redundancy**. Input styling is copy-pasted, validation is reimplemented per form, and the birth data form exists twice.

---

## 6. Pattern Audit: Typography

### Overview

| Metric | Value |
|--------|-------|
| Font families | 2 (Cinzel serif + Inter sans) |
| Text size classes used | 9 sizes (xs through 5xl) |
| Font weight classes used | 5 weights |
| Total heading elements (h1-h6) | 719 |
| Heading component | **NONE** |

### Text Size Distribution

| Size | Count | Semantic Role |
|------|-------|--------------|
| `text-xs` | 565 | Captions, helpers, metadata |
| `text-sm` | 816 | Labels, descriptions, body secondary |
| `text-base` | 13 | Body text (rarely used explicitly) |
| `text-lg` | 258 | Card titles, section labels |
| `text-xl` | 316 | Section headers |
| `text-2xl` | 179 | Page sub-headers |
| `text-3xl` | 120 | Page headers |
| `text-4xl` | 56 | Hero text, major headings |
| `text-5xl` | 22 | Extra-large emphasis (home page) |

### Font Weight Distribution

| Weight | Count | Usage |
|--------|-------|-------|
| `font-medium` | 525 | Default emphasis (most common) |
| `font-serif` | 87 | Display typography (Cinzel) |
| `font-semibold` | 29 | Strong emphasis |
| `font-bold` | 16 | Rare, strong emphasis |
| `font-light` | 1 | Minimal use |

### Implicit Typography Scale

| Level | Pattern | Used For |
|-------|---------|----------|
| Display | `font-serif text-4xl font-bold` | Hero sections, page banners |
| H1 | `font-serif text-3xl font-medium` | Page titles |
| H2 | `text-2xl text-white` | Section headers |
| H3 | `font-serif text-lg font-medium` | Card titles, subsections |
| Body | `text-neutral-300 text-sm` | Main content |
| Caption | `text-xs text-neutral-500` | Metadata, timestamps |

### Assessment

**GOOD** ‚Äî Typography is consistent through Tailwind's built-in scale. The `font-serif` (Cinzel) vs `font-sans` (Inter) distinction creates clear visual hierarchy. No urgent need for a Typography component, but documenting the implicit scale (above) prevents drift.

---

## 7. Pattern Audit: Colors & Theming

### Color Architecture

**Rating: EXCELLENT** ‚Äî This is the strongest aspect of the design system.

#### Centralized Color System

| Layer | Location | Purpose |
|-------|----------|---------|
| Tailwind config | `tailwind.config.js` | 8 custom color scales + neutral |
| Color utilities | `src/styles/colors.ts` | 6 typed color exports + helper functions |
| Global CSS | `src/styles/globals.css` | Base dark theme + heading fonts |

#### Custom Color Scales (Tailwind)

| Scale | Primary Hex | Shades | Domain |
|-------|-------------|--------|--------|
| fire | #FF6B35 | 300-700 + primary/secondary/tertiary | Mars, Sun, Jupiter; Fire element |
| earth | #2D5016 | 300-700 + primary/secondary/tertiary | Saturn, Pluto; Earth element |
| air | #4A90D9 | 300-700 + primary/secondary/tertiary | Mercury, Uranus; Air element |
| water | #1A5F7A | 300-700 + primary/secondary/tertiary | Moon, Venus, Neptune; Water element |
| humandesign | #F59E0B | 300-700 + primary/secondary/tertiary | HD system (amber/gold) |
| genekey | #8B5CF6 | 300-700 + primary/secondary/tertiary | Gene Keys (purple/violet) |
| numerology | #f5a623 | 50-900 | Master numbers (solar gold) |
| chakra | #db2777 | 50-900 | Energy body (rose/magenta) |

#### Color Usage Across Codebase

| Color Family | Instances | Primary Use |
|--------------|-----------|-------------|
| neutral-900/800 | 842 | Dark theme backgrounds |
| neutral-400/500/300 | 1,498 | Text hierarchy |
| humandesign-* | 249 | HD gates, centers, channels |
| genekey-* | 213 | GK spheres, sequences |
| air-* | 95 | Air element entities |
| fire-* | 79 | Fire element entities |
| water-* | 64 | Water element entities |
| earth-* | 58 | Earth element entities |
| amber-* | 121 (text) | Tradition accents |
| purple-* | 117 (text) | Tradition accents |

#### Hardcoded Colors

| Type | Count | Location | Assessment |
|------|-------|----------|-----------|
| D3/SVG colors | 82 | CelestialMandala, HouseSubstanceWheel, ConstellationGraph | **Expected** ‚Äî D3 requires literal values |
| Arbitrary Tailwind | 1 | `bg-[#9333EA]` in ProfileBodyGraph.tsx | **Fix** ‚Üí `bg-genekey-600` |
| Inline styles | 0 | ‚Äî | **Perfect** |

### Dark Theme

- **No `darkMode` config** ‚Äî entire app is dark-only
- Background: `#0D0D15` (neutral-950) ‚Üí `#18181B` (neutral-900)
- Text: white ‚Üí neutral-300 ‚Üí neutral-400 ‚Üí neutral-500 (4-level hierarchy)
- Borders: neutral-800 ‚Üí neutral-700
- 0 instances of `dark:` prefix found

---

## 8. Pattern Audit: Layout & Spacing

### Layout Utilities

| Pattern | Instances | Primary Use |
|---------|-----------|-------------|
| `flex` | 950 | Primary layout method (4.3x more than grid) |
| `grid` | 219 | Card grids, data layouts |
| `gap-*` | 975 | Spacing between flex/grid children |
| `rounded-*` | 1,119 | Border radius (cards, buttons, inputs) |
| `p-*` | 884 | Padding |
| `py-*` | 525 | Vertical padding |
| `px-*` | 463 | Horizontal padding |

### Page Layout Pattern (Consistent)

```
Container (max-w-*, mx-auto, px-4, py-8)
  ‚îî‚îÄ‚îÄ Heading Section (flex, justify-between, mb-6)
  ‚îî‚îÄ‚îÄ Filter/Control Bar (optional)
  ‚îî‚îÄ‚îÄ Content Grid (grid md:grid-cols-2 lg:grid-cols-3 gap-4)
      ‚îî‚îÄ‚îÄ Cards (p-6, rounded-xl, border, bg-neutral-900)
```

### Grid Patterns

| Pattern | Count | Use Case |
|---------|-------|----------|
| `grid-cols-2` | 180 | 2-column data grids |
| `grid-cols-3` | 75 | Entity card grids |
| `grid-cols-1` | 45 | Mobile single column |
| `grid-cols-4` | 33 | Dense data displays |
| `md:grid-cols-2` | Common | Responsive 1‚Üí2 column |
| `lg:grid-cols-3` | Common | Responsive 2‚Üí3 column |

### Container Widths

| Width | Use Case |
|-------|----------|
| `max-w-4xl` | Standard content pages |
| `max-w-3xl` | Narrower content (contemplation) |
| `max-w-2xl` | Forms, focused content |
| `max-w-lg` | Onboarding steps |
| No max-width | Full-width visualizations |

### Assessment

**GOOD** ‚Äî Spacing is consistent via Tailwind scale. Layout patterns are repeated organically (not via a shared Layout component, but consistently enough). Responsive design is mobile-first with `md:` breakpoints throughout.

---

## 9. Pattern Audit: Motion & Animation

### Animation Library

**Framer Motion** (v10.16.16) is the sole animation library, used in 11 components.

### Common Patterns

| Pattern | Usage | Location |
|---------|-------|----------|
| `initial/animate/exit` | Enter/leave transitions | Page transitions, modals |
| `whileTap={{ scale: 0.98 }}` | Button tap feedback | Interactive elements |
| `AnimatePresence` | Conditional render animations | Panels, modals, lists |
| `motion.div` | Animated containers | Cards, sections |
| Stagger children | Sequential item animation | Lists, grids |

### Shared Animation Configs (PageTransition.tsx)

```typescript
export const fadeInUp = { initial: { opacity: 0, y: 20 }, animate: { opacity: 1, y: 0 } };
export const staggerContainer = { animate: { transition: { staggerChildren: 0.1 } } };
export const scaleOnHover = { whileHover: { scale: 1.02 } };
```

### Custom CSS Animations (globals.css)

| Keyframe | Duration | Effect |
|----------|----------|--------|
| `fade-in` | 0.2s | Opacity 0‚Üí1 |
| `slide-in-right` | 0.3s | translateX(100%)‚Üí0 |
| `slide-out-right` | 0.3s | translateX(0)‚Üí100% |

### Assessment

**GOOD** ‚Äî Animations are consistent and performant. The `PageTransition.tsx` utilities provide reusable configs. No competing animation approaches (no Tailwind `animate-*` mixed with Framer).

---

## 10. Routing Architecture

### Overview

| Metric | Value |
|--------|-------|
| Total routes | 79 |
| Lazy-loaded pages | All (100%) |
| Suspense fallback | `<LoadingSkeleton variant="page" />` |
| Max nesting depth | 2 levels |
| Protected routes | 0 (no auth gating) |

### Route Organization

| Category | Routes | Pattern |
|----------|--------|---------|
| Profile | 12 | `/profile/**` nested |
| Astrology Library | 12 | `/planets`, `/signs`, etc. + `:id` |
| Human Design Library | 13 | `/human-design/**` + `:id` |
| Gene Keys Library | 11 | `/gene-keys/**` + `:id` |
| Wisdom Traditions | 6 | `/numerology`, `/chakras`, `/hermetic` + `:id` |
| Interactive Tools | 9 | `/wheel`, `/graph`, `/contemplate`, `/transits`, etc. |
| Unified Entities | 2 | `/lines`, `/lines/:id` |
| Other | 4 | `/`, `/onboarding`, `/insights`, `/sessions` |

### Route Pattern Analysis

- **List ‚Üí Detail pattern** is the dominant pattern (list page + `/:id` detail)
- **No route guards** ‚Äî app is fully accessible without auth
- **No 404 route** ‚Äî missing routes render blank within Layout
- **Specific before dynamic** ‚Äî e.g., `/gene-keys/codon-rings` before `/gene-keys/:id`

### Assessment

**GOOD** ‚Äî Routes are well-organized by domain, all lazy-loaded. Missing: 404 catch-all route, potential for route-level code splitting by tradition.

---

## 11. State Management

### Architecture

| Layer | Mechanism | Scope |
|-------|-----------|-------|
| Auth state | `AuthContext` (React Context) | Global |
| Profile state | `ProfileContext` (React Context) | Global |
| UI state | `useState` (182 instances across 42 files) | Component-local |
| Persistent data | `localStorage` (54 operations) | Browser |
| Cloud sync | Supabase (optional) | Remote |

### Hook Usage Census

| Hook | Instances | Files |
|------|-----------|-------|
| useState | 182 | 42 |
| useEffect | 45 | 19 |
| useMemo | 29 | 10 |
| useCallback | 26 | 7 |
| useRef | 19 | 8 |
| useContext | 4 | 2 (context definitions) |

### Heavy State Components

| Component | useState Count | Assessment |
|-----------|---------------|-----------|
| ContemplationChamber | 19 | **GOD STATE** ‚Äî streaming, session, pathway, UI all in one |
| ProfileCreationForm | 16 | Acceptable for complex form |
| Onboarding | 13 | Multi-step wizard state |

### Dead Dependencies

- **Zustand 4.4.7** ‚Äî listed in package.json, **zero imports** across entire codebase. Pure dead weight.

### Assessment

**ADEQUATE for current scale.** React Context + useState is sufficient for a single-user app with 2 global concerns (auth, profile). If the app grows to need shared transient state (e.g., real-time collaboration, complex dashboard filters), Zustand or another state manager would become necessary. For now, removing Zustand from dependencies is the only action needed.

---

## 12. Accessibility Audit (WCAG)

### Current State

| Metric | Count | Target (WCAG AA) | Gap |
|--------|-------|------------------|-----|
| aria-* attributes | 49 | 200+ | **Large** |
| role attributes | 10 | 50+ | **Large** |
| sr-only content | 1 | 20+ | **Critical** |
| Keyboard handlers | 8 | 30+ | **Large** |
| alt text on images | 7 | All images | **Moderate** |
| Focus management | 0 explicit | All modals/panels | **Critical** |
| ARIA live regions | 0 | Loading states, chat | **Critical** |
| Color contrast documented | No | Yes | **Gap** |

### What Works

1. **Skip-to-content link** (Layout.tsx) ‚Äî visible on keyboard focus
2. **aria-hidden on decorative icons** (18 instances in Layout)
3. **Keyboard shortcuts** ‚Äî Cmd+K search, Enter/Escape in chat
4. **Semantic HTML** ‚Äî h1-h6 headings, button elements (not div+onClick)
5. **Role attributes** on dynamic content (status, region)

### Critical Gaps

1. **No focus trap in modals/panels** ‚Äî EntityDetailPanel, AuthModal, InsightSaveButton modal all lack focus management
2. **No ARIA live regions** ‚Äî Loading states, chat messages, and async updates are invisible to screen readers
3. **D3 visualizations are inaccessible** ‚Äî CelestialMandala, ConstellationGraph, BodyGraph have zero ARIA support
4. **No visible focus indicators** beyond browser defaults ‚Äî custom focus styles missing
5. **Color-only information** ‚Äî Element colors (fire/earth/air/water) encode meaning without text alternative

### WCAG AA Compliance Estimate

| Principle | Score | Key Issues |
|-----------|-------|-----------|
| Perceivable | 40% | Color-only info, missing alt text, no live regions |
| Operable | 50% | Keyboard works partially, no focus management |
| Understandable | 70% | Consistent patterns, but error messages not accessible |
| Robust | 60% | Good semantic HTML, but missing ARIA for complex widgets |
| **Overall** | **~45%** | **Significant work needed for AA compliance** |

---

## 13. Error Handling & Resilience

### Current Implementation

| Layer | Mechanism | Coverage |
|-------|-----------|----------|
| Render errors | ErrorBoundary component | All routes (via Layout) |
| Service errors | try-catch per service | 13 of 34 services |
| API errors | Retry with backoff | claude.ts only |
| Cloud sync | Silent failure | profileSync, insightSync, sessionSync, pathwaySync |
| Form validation | Inline state-based | Per-form (not shared) |

### Error Handling Patterns

```typescript
// Pattern 1: Service try-catch (most common)
try {
  const data = JSON.parse(localStorage.getItem(key) || '[]');
  return data;
} catch (e) {
  console.error('[ServiceName]', e);
  return []; // Silent fallback
}

// Pattern 2: Cloud sync fire-and-forget
pushProfileToCloud(profile).catch(console.error);

// Pattern 3: API retry (claude.ts only)
for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
  try { return await fetch(...); }
  catch (e) { if (!isRetryableError(e)) throw e; await delay(backoff); }
}
```

### Gaps

1. **No user-facing error UI** beyond ErrorBoundary crash screen
2. **Silent cloud sync failures** ‚Äî user never knows if sync failed
3. **No toast/notification system** ‚Äî no way to surface non-fatal errors
4. **No offline detection** ‚Äî app doesn't know when it's offline
5. **No retry UI** ‚Äî failed operations have no "Try Again" affordance

---

## 14. Redundancy Analysis & Metrics

### Pattern Redundancy Matrix

| Pattern | Unique Variants | Total Instances | Shared Component | Redundancy Factor | Priority |
|---------|----------------|----------------|------------------|-------------------|----------|
| Buttons | 6 | 366 | None | 61.0x | **P0** |
| Input styling | 1 pattern | 16+ inputs | None | 16x | **P1** |
| Birth data form | 1 form | 2 implementations | None | 2.0x | **P1** |
| Entity routing | 1 function | 3+ implementations | None | 3.0x | **P2** |
| D3 setup code | 5 patterns | 5 components | None | 5.0x shared | **P2** |
| Element color maps | 1 map | 10+ files | Partial (colors.ts) | 1.5x | **P3** |
| Profile detail layout | 1 pattern | 6 pages | None | 6.0x | **P2** |
| Card styling | 2 patterns | 50+ cards | Partial (EntityCard) | ~1.5x | **P3** |

### Code Duplication Hotspots

1. **Button gradient string** (`from-amber-600 to-purple-600`) ‚Äî 40+ files
2. **Input class string** (`bg-neutral-800 border border-neutral-700 rounded-lg...`) ‚Äî 16+ instances
3. **Birth data validation** ‚Äî ProfileCreationForm.tsx + Onboarding.tsx (~200L duplicated)
4. **Entity path resolution** ‚Äî SearchBar.tsx + EntityCard.tsx + ConstellationGraph.tsx
5. **D3 SVG setup** ‚Äî 5 visualization components (~100L shared patterns)
6. **Profile detail page structure** ‚Äî 6 profile sub-pages (~150L shared layout)

### Estimated Savings from Component Extraction

| Component to Extract | Current Lines | After Extraction | Savings |
|---------------------|--------------|-----------------|---------|
| Button (6 variants) | ~1,800L scattered | 150L component + 366 call sites | ~1,400L |
| Input/Select/Textarea | ~400L scattered | 120L components + 16 call sites | ~280L |
| BirthDataForm (shared) | ~800L (2 copies) | 400L shared + 2 wrappers | ~350L |
| D3 utilities | ~500L duplicated | 150L utilities | ~350L |
| ProfileDetailLayout | ~900L (6 pages) | 200L layout + 6 slim pages | ~500L |
| Entity route resolver | ~150L (3 copies) | 50L utility | ~100L |
| **TOTAL ESTIMATED** | | | **~2,980L** (~7.6% of frontend) |

---

## 15. Systems Design Principles

### Current System Properties

Analyzing Cosmic Blueprint through a systems thinking lens reveals both emergent strengths and structural risks:

#### Strengths (Emergent Properties)

1. **Coherence Through Convention** ‚Äî Despite no formal design system, the app looks cohesive because:
   - Element-based color scales create semantic consistency (fire=warm, water=cool)
   - Tailwind's constraint-based approach prevents wild styling drift
   - One developer (you) maintaining style memory across sprints

2. **Graceful Degradation** ‚Äî The local-first architecture creates genuine resilience:
   - Supabase offline ‚Üí app fully functional
   - FreeAstroAPI unavailable ‚Üí internal calculation fallback
   - Auth optional ‚Üí zero-friction exploration

3. **Domain Alignment** ‚Äî The component structure mirrors the domain model:
   - 3 wisdom traditions ‚Üí 3 profile sections ‚Üí 3 color families
   - 12 houses ‚Üí 12 life areas ‚Üí 12 astrological routes
   - Entity type hierarchy ‚Üí route hierarchy ‚Üí component hierarchy

#### Risks (Structural Debt)

1. **Convention Fragility** ‚Äî Styling consistency depends on developer memory, not system enforcement. As the team grows or time passes, drift is inevitable without:
   - Extracted components (Button, Input, Card)
   - Documented design tokens
   - Visual regression testing

2. **God Component Gravity** ‚Äî ContemplationChamber (1,345L) and EntityDetailPanel (1,215L) attract more logic because it's easier to add to them than to refactor. This creates:
   - Increasing coupling (more state, more conditions)
   - Testing difficulty (can't test sub-features in isolation)
   - Performance risk (re-renders cascade through large trees)

3. **Accessibility Gap** ‚Äî The current 45% WCAG score means ~55% of the interface is partially or fully inaccessible to users with disabilities. For a "digital temple for self-discovery," this creates an ironic exclusion of seekers who navigate differently.

### Recommended System Architecture Principles

#### Principle 1: Extract, Don't Add

Before creating any new component, check if the pattern already exists inline. The codebase has 6 button variants ‚Äî don't create a 7th. Extract the existing 6 into a `Button` component.

**Rule:** `REUSE > EXTRACT > CREATE`

#### Principle 2: Tokens Before Components

Design tokens (colors, spacing, typography, shadows) should be the foundation. Components consume tokens. Pages consume components. This creates a **unidirectional dependency flow**:

```
Tokens ‚Üí Atoms ‚Üí Molecules ‚Üí Organisms ‚Üí Pages
         ‚Üë (Atomic Design hierarchy)
```

The current codebase already has excellent tokens (tailwind.config.js + colors.ts). The gap is atoms (Button, Input, Card primitive) and molecules (BirthDataForm, EntityDetailCard).

#### Principle 3: Accessible by Architecture

Don't bolt accessibility on later. Build it into component primitives:
- Button ‚Üí always has `aria-label` or text content
- Input ‚Üí always linked to label via `htmlFor`/`id`
- Modal ‚Üí always traps focus, has `role="dialog"`, `aria-modal`
- Loading states ‚Üí always have `aria-live="polite"`

This means fixing accessibility ONCE in 5-8 components, not 366 button instances.

#### Principle 4: Domain-Driven Component Boundaries

Cosmic Blueprint's natural domain boundaries should define component boundaries:

| Domain | Shared Components | Domain-Specific |
|--------|------------------|-----------------|
| Core UI | Button, Input, Card, Modal, Toast | ‚Äî |
| Entity System | EntityCard, EntityLink, EntityPicker, EntityDetail | ‚Äî |
| Astrology | ‚Äî | CelestialMandala, AspectWeaver |
| Human Design | ‚Äî | BodyGraph, CenterCard |
| Gene Keys | ‚Äî | SphereCard, SpectrumBar |
| Contemplation | ‚Äî | ChatMessage, ChatInput, PersonaPicker |
| Visualization | D3Container, ColorScale | (domain-specific visualizations extend these) |

#### Principle 5: State Locality

The current architecture already follows this well ‚Äî state lives where it's used. Preserve this:
- **Global state** (Context): Auth + Active Profile only
- **Page state** (useState): Filters, search, selections
- **Persistent state** (localStorage): Profiles, insights, sessions
- **Derived state** (useMemo): Calculations from profile data

Don't add Zustand or Redux unless cross-page transient state becomes necessary.

#### Principle 6: Progressive Enhancement for Accessibility

Given the 45% WCAG baseline, prioritize by impact:

1. **Keyboard navigation** ‚Äî focus management in modals/panels (affects all keyboard users)
2. **ARIA live regions** ‚Äî chat messages, loading states (affects screen reader users)
3. **Color + text** ‚Äî don't rely on color alone for element identification (affects color-blind users)
4. **Focus indicators** ‚Äî visible custom focus rings (affects keyboard users)
5. **D3 alternatives** ‚Äî text summaries for visualizations (affects screen reader users)

---

## 16. Design System Roadmap

### Phase A: Atomic Extraction (Recommended First)

Extract existing patterns into 5-8 atomic components. **Zero visual changes** ‚Äî just move inline patterns into shared components.

| Component | Source Pattern | Variants | Priority |
|-----------|--------------|----------|----------|
| `Button` | 6 identified variants | primary, secondary, ghost, pill, icon, small | **P0** |
| `Input` | Form input pattern | text, number, date, time, email, textarea, select | **P0** |
| `Card` | EntityCard extension | default, compact, interactive | **P1** |
| `Modal` | EntityDetailPanel/AuthModal | overlay, sidebar, dialog | **P1** |
| `Toast` | New (no current pattern) | info, success, warning, error | **P2** |
| `Badge` | Inline tag pattern | element, tradition, status | **P2** |

### Phase B: Molecule Composition

Compose atoms into reusable molecules:

| Molecule | Atoms Used | Replaces |
|----------|-----------|----------|
| `BirthDataForm` | Input, Select, Button | ProfileCreationForm + Onboarding duplicate |
| `ProfileDetailLayout` | Card, Badge, Button | 6 profile detail pages |
| `EntitySearchSelect` | Input, Card | SearchBar + EntityPicker overlap |

### Phase C: Organism Enhancement

Refactor god components:

| Organism | Current Lines | Target | Strategy |
|----------|--------------|--------|----------|
| ContemplationChamber | 1,345 | ~400 + sub-components | Extract ChatMessages, ChatInput, SessionManager, PathwayTracker |
| EntityDetailPanel | 1,215 | ~300 + type renderers | Extract entity type render handlers into registry |
| Profile | 1,202 | ~400 + tradition panels | Extract AstrologyPanel, HDPanel, GKPanel |

### Phase D: Accessibility Integration

Build a11y into the atomic components from Phase A:

| Component | A11y Features |
|-----------|--------------|
| Button | `aria-label`, `aria-disabled`, focus ring, keyboard activation |
| Input | `id`/`htmlFor` label linking, `aria-invalid`, `aria-describedby` for errors |
| Modal | Focus trap, `role="dialog"`, `aria-modal`, Escape to close |
| Toast | `role="alert"`, `aria-live="assertive"` |
| D3Container | `aria-label`, text alternative summary, `role="img"` |

### Phase E: Design Token Formalization

Extract current Tailwind config into a documented token system:

```
tokens/
‚îú‚îÄ‚îÄ colors.ts       (element, tradition, neutral, semantic)
‚îú‚îÄ‚îÄ typography.ts   (font families, sizes, weights, line heights)
‚îú‚îÄ‚îÄ spacing.ts      (padding, margin, gap scales)
‚îú‚îÄ‚îÄ borders.ts      (radius, widths, colors)
‚îú‚îÄ‚îÄ shadows.ts      (if needed ‚Äî currently none)
‚îî‚îÄ‚îÄ motion.ts       (durations, easings, animation configs)
```

### Effort Estimates

| Phase | Scope | Estimated Impact |
|-------|-------|-----------------|
| A: Atomic Extraction | 5-8 components | -2,000L redundancy, consistent buttons/inputs |
| B: Molecules | 3 molecules | -500L, birth form deduplicated |
| C: Organisms | 3 refactors | -2,000L in god components, testable sub-components |
| D: Accessibility | Integrated with A-C | WCAG 45% ‚Üí ~75% |
| E: Tokens | Documentation | Future-proofing, team scalability |

---

## 17. Questions for Phase 4+ Review

### For @architect (Aria):
1. Should the atomic components live in `src/components/ui/` or a separate package?
2. Is the current Context-based state sufficient for planned features, or should we plan for Zustand/Jotai?
3. Should the D3 visualizations be extracted to a separate module for code-splitting?
4. What's the strategy for the god components ‚Äî refactor now or as features are added?

### For @dev (Dex):
1. Can you identify which of the 6 button variants are actually intentional vs. drift?
2. Is there a preference for building components with Radix primitives vs. from scratch?
3. What's the testing strategy for extracted components ‚Äî unit tests, visual snapshots, or both?

### For @qa (Quinn):
1. What's the priority for WCAG compliance ‚Äî AA minimum or AAA aspirational?
2. Should visual regression testing be added as part of the atomic component extraction?
3. Is the 1-test-file status (aspects.test.ts only) a blocker for component extraction?

### For @po (Pax):
1. Is the design system extraction a standalone epic or woven into feature work?
2. What's the business priority: accessibility compliance vs. new features?
3. Should we track a "design debt score" alongside technical debt?

---

*Document Version: 1.0 ‚Äî Phase 3 of 10 (Brownfield Discovery)*
*Next: Phase 4 (@architect ‚Äî Technical Debt Draft) using Phase 1 + Phase 3 findings*
*Generated by: Uma (UX-Design Expert) ‚Äî Empathetic yet data-driven*

‚Äî Uma, desenhando com empatia üíù
