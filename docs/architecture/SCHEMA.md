# Data Architecture & Schema â€” Cosmic Blueprint
**Generated by:** @data-engineer (Dara) â€” Brownfield Discovery Phase 2
**Date:** 2026-02-20
**Workflow:** brownfield-discovery v2.0
**Status:** Phase 2 Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Data Architecture Overview](#2-data-architecture-overview)
3. [Supabase Schema (Cloud)](#3-supabase-schema-cloud)
4. [localStorage Schema (Client)](#4-localstorage-schema-client)
5. [Static Knowledge Base](#5-static-knowledge-base)
6. [TypeScript Type System](#6-typescript-type-system)
7. [Core Calculation Pipeline](#7-core-calculation-pipeline)
8. [Sync Architecture](#8-sync-architecture)
9. [Entity Registry](#9-entity-registry)
10. [Cross-Tradition Data Bridges](#10-cross-tradition-data-bridges)

---

## 1. Executive Summary

Cosmic Blueprint has a **four-layer data architecture**:

| Layer | Technology | Purpose | Records |
|-------|-----------|---------|---------|
| **Static Knowledge Base** | 29 JSON files â†’ typed Maps | Universal wisdom traditions data | 700+ entities |
| **Pre-computed Ephemeris** | 1 JSON file (5,840 days) | Planetary positions 2020-2035 | ~58,400 data points |
| **Client Persistence** | localStorage (4 keys) | Profiles, insights, sessions, pathways | User-generated |
| **Cloud Sync** | Supabase PostgreSQL (4 tables) | Optional backup + multi-device | Mirror of localStorage |

**Key Design Decisions:**
- **Local-first:** App works fully without auth or network
- **Text primary keys:** Client-generated IDs (not server UUIDs)
- **JSONB for flexibility:** `profile_data` and `messages` stored as JSONB
- **Additive sync:** Cloud merge never deletes â€” only adds missing items
- **Single user scope:** All RLS policies enforce `auth.uid() = user_id`

---

## 2. Data Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATA FLOW DIAGRAM                            â”‚
â”‚                                                                     â”‚
â”‚  BirthData (input)                                                  â”‚
â”‚       â”‚                                                             â”‚
â”‚       â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Ephemeris Layer    â”‚    â”‚   Static Knowledge Base          â”‚  â”‚
â”‚  â”‚   positions-2020-    â”‚    â”‚   29 JSON â†’ typed Maps           â”‚  â”‚
â”‚  â”‚   2035.json          â”‚    â”‚   700+ entities                  â”‚  â”‚
â”‚  â”‚   + astronomy-engine â”‚    â”‚   (planets, signs, gates,        â”‚  â”‚
â”‚  â”‚   (fallback)         â”‚    â”‚    keys, channels, etc.)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                   â”‚                     â”‚
â”‚           â–¼                                   â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Calculation Pipeline                            â”‚   â”‚
â”‚  â”‚  chartCalculation â†’ aspects â†’ transits â†’ enrichment         â”‚   â”‚
â”‚  â”‚  CalculatedChart + GeneKeysProfile + HumanDesignProfile     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                     â”‚
â”‚                               â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Entity Registry                              â”‚  â”‚
â”‚  â”‚  ~700 universal + ~150 profile entities â†’ searchable index    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                     â”‚
â”‚                               â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   localStorage      â”‚â—„â”€â”€â–ºâ”‚   Supabase (optional)            â”‚  â”‚
â”‚  â”‚   (PRIMARY)         â”‚syncâ”‚   4 tables + RLS                  â”‚  â”‚
â”‚  â”‚   4 keys            â”‚    â”‚   Cloud backup                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚                                     â”‚
â”‚                               â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Tana ILOS (one-way export via MCP)                          â”‚  â”‚
â”‚  â”‚   Workspace: Nd-vpOR3Vvg3                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Supabase Schema (Cloud)

### 3.1 Overview

| Table | Schema | PK Type | RLS | Trigger | Indexes |
|-------|--------|---------|-----|---------|---------|
| `saved_insights` | `public.` | TEXT | 4 policies | `handle_updated_at` | 4 |
| `cosmic_profiles` | `public.` | TEXT | 4 policies | `handle_updated_at` | 2 |
| `pathway_progress` | `public.` | TEXT | 4 policies | `handle_updated_at` | 2 |
| `contemplation_sessions` | *(missing `public.`)* | TEXT | 4 policies | `handle_updated_at` | 2 |

**Shared Function:** `public.handle_updated_at()` â€” BEFORE UPDATE trigger on all 4 tables, sets `NEW.updated_at = NOW()`.

### 3.2 Migration History

| # | File | Purpose |
|---|------|---------|
| 001 | `001_initial_schema.sql` | `saved_insights` + `cosmic_profiles` + `handle_updated_at()` |
| 002 | `002_pathway_progress.sql` | `pathway_progress` table |
| 003 | `003_contemplation_sessions.sql` | `contemplation_sessions` table |
| 004 | `004_pathway_timestamp_defaults.sql` | Add DEFAULT NOW() to pathway timestamps |
| 005 | `005_insight_indexes.sql` | Add category + type indexes on insights |

### 3.3 Table: `public.saved_insights`

```sql
CREATE TABLE IF NOT EXISTS public.saved_insights (
  id                 TEXT        PRIMARY KEY,
  user_id            UUID        NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content            TEXT        NOT NULL,
  category           TEXT        NOT NULL,
  contemplation_type TEXT        NOT NULL,
  tags               TEXT[]      NOT NULL DEFAULT '{}',
  session_id         TEXT,                          -- No FK (orphan risk)
  focus_entity       TEXT,                          -- Entity ID as string
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Indexes:**
- `idx_saved_insights_user_id` ON `(user_id)`
- `idx_saved_insights_created_at` ON `(user_id, created_at DESC)`
- `idx_saved_insights_category` ON `(category)` â€” Migration 005
- `idx_saved_insights_type` ON `(type)` â€” Migration 005 (column name mismatch: should be `contemplation_type`)

**RLS Policies:** SELECT/INSERT/UPDATE/DELETE â€” all `auth.uid() = user_id`

### 3.4 Table: `public.cosmic_profiles`

```sql
CREATE TABLE IF NOT EXISTS public.cosmic_profiles (
  id            TEXT        PRIMARY KEY,
  user_id       UUID        NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name          TEXT        NOT NULL,
  profile_data  JSONB       NOT NULL,               -- Full CosmicProfile v2
  is_active     BOOLEAN     NOT NULL DEFAULT FALSE,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Indexes:**
- `idx_cosmic_profiles_user_id` ON `(user_id)`
- `idx_cosmic_profiles_active_user` UNIQUE ON `(user_id)` WHERE `is_active = TRUE`

**RLS Policies:** SELECT/INSERT/UPDATE/DELETE â€” all `auth.uid() = user_id`

### 3.5 Table: `public.pathway_progress`

```sql
CREATE TABLE IF NOT EXISTS public.pathway_progress (
  id                 TEXT        PRIMARY KEY,        -- Composite: {userId}_{pathwayId}
  user_id            UUID        NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  pathway_id         TEXT        NOT NULL,
  current_step_index INTEGER     NOT NULL DEFAULT 0,
  completed_steps    TEXT[]      NOT NULL DEFAULT '{}',
  journal_entries    JSONB       NOT NULL DEFAULT '{}',
  started_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),   -- Default added in 004
  last_activity_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),   -- Default added in 004
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Indexes:**
- `idx_pathway_progress_user_id` ON `(user_id)`
- `idx_pathway_progress_user_pathway` UNIQUE ON `(user_id, pathway_id)`

**RLS Policies:** SELECT/INSERT/UPDATE/DELETE â€” all `auth.uid() = user_id`

### 3.6 Table: `contemplation_sessions`

```sql
CREATE TABLE IF NOT EXISTS contemplation_sessions (  -- NOTE: missing public. prefix
  id                 TEXT        PRIMARY KEY,
  user_id            UUID        NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  category           TEXT        NOT NULL,
  contemplation_type TEXT        NOT NULL,
  focus_entity       JSONB,                          -- Full entity object (vs TEXT in insights)
  messages           JSONB       NOT NULL DEFAULT '[]'::jsonb,
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Indexes:**
- `idx_contemplation_sessions_user_id` ON `(user_id)`
- `idx_contemplation_sessions_updated_at` ON `(user_id, updated_at DESC)`

**RLS Policies:** SELECT/INSERT/UPDATE/DELETE â€” all `auth.uid() = user_id`

### 3.7 Entity Relationship Diagram

```
auth.users (Supabase managed)
    â”‚
    â”œâ”€â”€ 1:N â”€â”€ saved_insights          (user_id FK, CASCADE)
    â”‚            â”œâ”€â”€ session_id TEXT     (NO FK â†’ orphan risk)
    â”‚            â””â”€â”€ focus_entity TEXT   (entity ID, no FK)
    â”‚
    â”œâ”€â”€ 1:N â”€â”€ cosmic_profiles         (user_id FK, CASCADE)
    â”‚            â”œâ”€â”€ profile_data JSONB  (full CosmicProfile)
    â”‚            â””â”€â”€ UNIQUE(user_id) WHERE is_active
    â”‚
    â”œâ”€â”€ 1:N â”€â”€ pathway_progress        (user_id FK, CASCADE)
    â”‚            â””â”€â”€ UNIQUE(user_id, pathway_id)
    â”‚
    â””â”€â”€ 1:N â”€â”€ contemplation_sessions  (user_id FK, CASCADE)
                 â”œâ”€â”€ focus_entity JSONB  (full entity object)
                 â””â”€â”€ messages JSONB      (conversation array)
```

**Note:** No cross-table FKs exist between the 4 user tables. `session_id` in `saved_insights` references `contemplation_sessions.id` conceptually but has no FK constraint.

---

## 4. localStorage Schema (Client)

### 4.1 Key Registry

| Key | Data Shape | Max Items | Service |
|-----|-----------|-----------|---------|
| `cosmic-copilot-profiles` | `CosmicProfile[]` | 10 | profiles.ts |
| `cosmic-copilot-active-profile-id` | `string` | 1 | profiles.ts |
| `cosmic-copilot-seeded` | `'1'` | Flag | profiles.ts |
| `cosmic-copilot-saved-insights` | `SavedInsight[]` | 100 | insights.ts |
| `cosmic-copilot-contemplation-sessions` | `SavedSession[]` | 20 | sessions.ts |
| `cosmic-copilot-pathway-progress` | `PathwayProgress[]` | Unlimited | pathways.ts |

### 4.2 Storage Limits & Risk

- **Browser localStorage limit:** ~5-10MB per domain
- **Profiles (10 max):** ~50-100KB per profile (JSONB with chart data) â†’ ~1MB max
- **Insights (100 max):** ~1-5KB per insight â†’ ~500KB max
- **Sessions (20 max):** ~5-50KB per session (full message arrays) â†’ ~1MB max
- **Pathways:** ~1-5KB per pathway â†’ minimal
- **Total estimated max:** ~2.5MB â€” well within 5MB limit

### 4.3 ID Generation Patterns

| Entity | Pattern | Example |
|--------|---------|---------|
| Profile | Slug from name | `felipe-fraga` |
| Insight | `insight-${timestamp}-${random}` | `insight-1708372800000-a7b3` |
| Session | `session-${timestamp}-${random}` | `session-1708372800000-c4d2` |
| Pathway Progress | `${pathwayId}` | `golden-path-activation` |

---

## 5. Static Knowledge Base

### 5.1 Universal Data Files (29 JSON â†’ typed Maps)

| File | Entity Type | Count | Key Fields |
|------|------------|-------|------------|
| planets.json | `planet` | 14 | planetType, importance, signsRuled, archetype |
| signs.json | `sign` | 12 | orderInZodiac, modality, elementId, rulingPlanetIds |
| houses.json | `house` | 12 | houseNumber, houseType, rulingSignId, lifeAreaFocus |
| elements.json | `element` | 4+3 | modalityExpression, balancingPractice |
| aspects.json | `aspect` | ~10 | angle, orbRange, nature |
| configurations.json | `configuration` | ~8 | aspect patterns (stellium, T-square, etc.) |
| decans.json | `decan` | 36 | 3 per sign, sub-rulers |
| dignities.json | `dignity` | ~12 | domicile, exaltation, detriment, fall |
| hd-gates.json | `hd-gate` | 64 | gateNumber, centerId, degreeStart/End, geneKeyId |
| hd-channels.json | `hd-channel` | 36 | gate1Id, gate2Id, center1Id, center2Id, circuitType |
| hd-centers.json | `hd-center` | 9 | centerType, biologicalCorrelate, gateIds |
| hd-types.json | `hd-type` | 5 | Generator, MG, Projector, Manifestor, Reflector |
| hd-authorities.json | `hd-authority` | 7 | Emotional, Sacral, Splenic, etc. |
| hd-profiles.json | `hd-profile` | 12 | 1/3 through 6/3 |
| hd-lines.json | `hd-line` | 6 | archetype, theme |
| hd-strategies.json | `hd-strategy` | 5 | one per type |
| hd-variables.json | `hd-variable` | 4 | Determination, Cognition, Environment, Motivation |
| gene-keys.json | `gene-key` | 64 | shadow, gift, siddhi (FrequencyExpression), hdGateId |
| gk-spheres.json | `gk-sphere` | 11 | sequence, sequenceOrder, planetarySource |
| gk-sequences.json | `gk-sequence` | 3 | Activation, Venus, Pearl |
| gk-lines.json | `gk-line` | 6 | line perspective on GK |
| codon-rings.json | `codon-ring` | 21 | geneKeyIds, aminoAcid, theme |
| amino-acids.json | `amino-acid` | 21 | abbreviation, type, physiologicalRole |
| trigrams.json | `trigram` | 8 | I Ching trigrams |
| lines.json | `line` | 6 | UNIFIED: geneKeys + humanDesign perspectives |
| numerology.json | `numerology-number` | 11 | 1-9 + master 11, 22, 33 |
| chakras.json | `chakra` | 7 | sanskritName, color, frequency, relatedHDCenters |
| hermetic-principles.json | `hermetic-principle` | 7 | Kybalion principles |
| cross-tradition-map.json | mapping | 12 entries | sign â†’ house/chakra/element/alchemy bridge |

**Total: 29 files, 700+ entities, loaded as type-safe `Map<string, Entity>` via `src/data/index.ts`**

### 5.2 Ephemeris Data

- **File:** `src/data/ephemeris/positions-2020-2035.json`
- **Structure:** `{ meta: { startDate, endDate, planets[] }, data: number[][] }`
- **Each row:** 10 numbers = ecliptic longitudes for [sun, moon, mercury, venus, mars, jupiter, saturn, uranus, neptune, pluto]
- **Rows:** ~5,840 (one per day, 2020-01-01 to 2035-12-31)
- **Lookup:** O(1) via day index from start date
- **Fallback:** `astronomy-engine` library for dates outside range

### 5.3 ILOS Context Data

| File | Purpose | Shape |
|------|---------|-------|
| `active-snapshot.json` | Current ILOS state | Life areas, active projects, goals |
| `area-house-bridge.json` | Felipe's house-to-area mapping | 12 entries with Tana node IDs |
| `methodology.json` | VPER cycle methodology | Vision/Plan/Execute/Review |
| `personal-context.json` | Personal values, life philosophy | Used in AI contemplation |

---

## 6. TypeScript Type System

### 6.1 Entity Type Hierarchy

```
AstroEntity (base: id, type, name, symbol?, description?)
  â”œâ”€â”€ Planet (planetType, importance, signsRuled, archetype)
  â”œâ”€â”€ ZodiacSign (orderInZodiac, modality, elementId)
  â”œâ”€â”€ House (houseNumber, houseType, lifeAreaFocus)
  â”œâ”€â”€ Element (modalityExpression, balancingPractice)
  â”œâ”€â”€ Aspect (angle, orbRange, nature)
  â”œâ”€â”€ Decan, Dignity, Configuration
  â”œâ”€â”€ HDGate (gateNumber, centerId, degreeStart/End, geneKeyId)
  â”œâ”€â”€ HDChannel (gate1Id, gate2Id, circuitType)
  â”œâ”€â”€ HDCenter (centerType, gateIds, definedMeaning)
  â”œâ”€â”€ HDTypeEntity, HDStrategyEntity, HDAuthorityEntity
  â”œâ”€â”€ GeneKey (shadow, gift, siddhi, hdGateId, codonRingId)
  â”œâ”€â”€ GKSphereEntity, CodonRing, AminoAcid
  â”œâ”€â”€ Line (UNIFIED: geneKeys + humanDesign perspectives)
  â”œâ”€â”€ NumerologyNumber (harmonicTone, chakraId, solfeggioHz)
  â”œâ”€â”€ Chakra (sanskritName, frequency, relatedHDCenters)
  â””â”€â”€ HermeticPrinciple (latinName, element, planet)
```

**Discriminator:** `EntityType` union (49 literal string types)

### 6.2 Profile Type Hierarchy

```
CosmicProfile (v2 â€” current format)
  â”œâ”€â”€ meta: ProfileMeta (id, name, relationship, dates)
  â”œâ”€â”€ birthData: BirthData (immutable input)
  â”œâ”€â”€ calculatedChart?: CalculatedChart (cached calculations)
  â”‚     â”œâ”€â”€ natalPositions: PlanetaryPosition[]
  â”‚     â”œâ”€â”€ designPositions: PlanetaryPosition[]
  â”‚     â”œâ”€â”€ natalGates: HDGateActivation[]
  â”‚     â””â”€â”€ designGates: HDGateActivation[]
  â”œâ”€â”€ geneKeysProfile?: GeneKeysProfile
  â”‚     â””â”€â”€ 15 GeneKeySphere objects across 3 sequences
  â”œâ”€â”€ humanDesignProfile?: HumanDesignProfile
  â”‚     â”œâ”€â”€ type, strategy, authority, profile, definition
  â”‚     â”œâ”€â”€ personalityGates, designGates
  â”‚     â””â”€â”€ definedCenterIds, definedChannelIds
  â”œâ”€â”€ numerologyProfile?: NumerologyProfile
  â”œâ”€â”€ chakraActivations?: ChakraActivation[]
  â”œâ”€â”€ alchemicalProfile?: AlchemicalProfile
  â”œâ”€â”€ placements?: NatalPlacement[]
  â”œâ”€â”€ housePositions?: HousePosition[]
  â”œâ”€â”€ aspects?: { planetary, other }
  â”œâ”€â”€ configurations?: NatalConfiguration[]
  â””â”€â”€ elementalAnalysis?: ElementalAnalysis

AstroProfile (v1 â€” legacy, auto-migrated to v2 on read)
```

### 6.3 Profile Entity Types (Discriminated Union)

| Type | ID Pattern | Used In |
|------|-----------|---------|
| `profile-placement` | `{profileId}:placement:{planetId}` | Astrology natal placements |
| `profile-gk-placement` | `{profileId}:gk:{sphereKey}` | Gene Key sphere assignments |
| `profile-hd-placement` | `{profileId}:hd:{gate}.{line}:{p\|d}` | HD gate activations |
| `profile-aspect` | `{profileId}:aspect:{p1}-{type}-{p2}` | Natal aspects |
| `profile-channel` | `{profileId}:channel:{channelId}` | HD defined channels |
| `profile-configuration` | `{profileId}:config:{configId}` | Aspect configurations |

---

## 7. Core Calculation Pipeline

### 7.1 Data Flow

```
BirthData { date, time, lat, lon }
  â”‚
  â–¼ parseBirthToUTC()
  â”‚
  â–¼ getPlanetaryPositions(natalDate)  â”€â”€â”€â”€ Ephemeris Layer
  â”‚   â””â”€ Pre-computed (O(1)) or astronomy-engine fallback
  â”‚
  â–¼ toPlanetaryPositions()
  â”‚   â””â”€ longitude â†’ { signId, degree, minute, retrograde }
  â”‚
  â”œâ”€â”€â–¶ calculateDesignDate()  â”€â”€â”€â”€ Binary search: Sun -88Â° (20 iterations)
  â”‚     â””â”€ getPlanetaryPositions(designDate)
  â”‚
  â”œâ”€â”€â–¶ toGateActivations(natal, isPersonality=true)   â”€â”€â”€ HD Gates
  â”œâ”€â”€â–¶ toGateActivations(design, isPersonality=false)
  â”‚
  â”œâ”€â”€â–¶ calculateDefinedCenters()  â”€â”€â”€ Channel completion check
  â”œâ”€â”€â–¶ determineHDType()          â”€â”€â”€ Sacral/Motor-to-Throat logic
  â”œâ”€â”€â–¶ determineHDAuthority()     â”€â”€â”€ Center hierarchy
  â”œâ”€â”€â–¶ getHDProfile()             â”€â”€â”€ Sun personality/design lines
  â”‚
  â”œâ”€â”€â–¶ calculateGeneKeysProfile() â”€â”€â”€ 15 spheres from natal+design positions
  â”‚
  â””â”€â”€â–¶ enrichProfile()            â”€â”€â”€ Numerology + Chakra + Alchemy
```

### 7.2 Key Algorithms

| Algorithm | Location | Complexity | Notes |
|-----------|----------|-----------|-------|
| Ephemeris lookup | ephemeris.ts | O(1) | Day index into pre-computed array |
| Design date | chartCalculation.ts:145-186 | O(20) | Binary search, 20 ephemeris calls |
| Gate from degree | data/index.ts | O(64) | Linear search through 64 gate ranges |
| Defined centers | chartCalculation.ts | O(36) | Check all 36 channels for completion |
| Natal aspects | aspects.ts | O(N^2) | Pairwise for ~10 planets = ~55 pairs |
| Transit aspects | transitAspects.ts | O(N*M) | N transits * M natal positions |

### 7.3 Known Calculation Gaps

| Gap | Severity | Impact |
|-----|----------|--------|
| Retrograde always returns `false` | HIGH | Incorrect natal chart display |
| Timezone handling simplified | HIGH | Birth time offset may be wrong |
| HD Type logic simplified | MEDIUM | Motor-to-throat connection not fully checked |
| Ephemeris daily precision only | MEDIUM | Design date limited to daily accuracy for pre-computed |
| No house system specification | MEDIUM | Placidus assumed but not stored |
| No calculation caching | LOW | Design date recalculated every profile load |

---

## 8. Sync Architecture

### 8.1 Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   localStorage   â”‚ â—„â”€â”€â”€â”€ PRIMARY â”€â”€â”€â–º â”‚   Application    â”‚
â”‚   (4 keys)       â”‚                    â”‚   State          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Sync Decision     â”‚
    â”‚   if (signedIn) {   â”‚
    â”‚     pushToCloud()   â”‚
    â”‚   }                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ async, best-effort
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Supabase          â”‚
    â”‚   (4 tables)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Sync Operations per Domain

| Domain | Push | Pull | Merge (Sign-In) | Delete |
|--------|------|------|-----------------|--------|
| Profiles | upsert | select | Additive merge by ID | delete |
| Insights | upsert | select | Additive merge by ID | delete |
| Sessions | upsert | select | Additive merge by ID | delete |
| Pathways | upsert | select | Additive merge by ID | *(no delete)* |

### 8.3 Merge Algorithm (All 4 Domains)

```
syncOnSignIn(user):
  1. cloudItems = fetchFromCloud(user.id)
  2. localItems = loadFromLocalStorage()
  3. cloudIds = Set(cloudItems.map(i => i.id))
  4. localIds = Set(localItems.map(i => i.id))
  5. For each cloud NOT in local â†’ save to localStorage
  6. For each local NOT in cloud â†’ push to Supabase
  7. NO DELETION (additive only)
```

### 8.4 Sync Risks

| Risk | Severity | Scenario |
|------|----------|----------|
| **Deleted data reappears** | HIGH | Delete locally â†’ sign out â†’ sign in â†’ cloud copy restored |
| **No conflict resolution** | HIGH | Edit on device A + edit on device B â†’ last write wins |
| **Silent sync failures** | MEDIUM | Cloud push fails â†’ `.catch(console.error)` â†’ user unaware |
| **No retry mechanism** | MEDIUM | Failed pushes are lost (no queue, no retry) |
| **Stale UI after merge** | LOW | Sign-in merge happens async, UI may not reflect merged data immediately |

---

## 9. Entity Registry

### 9.1 Architecture

```
EntityRegistry (singleton)
  â”œâ”€â”€ Universal entities (~700): loaded once at initialization
  â”‚     â”œâ”€â”€ Astrology: planets, signs, houses, aspects, etc.
  â”‚     â”œâ”€â”€ Human Design: gates, channels, centers, types
  â”‚     â”œâ”€â”€ Gene Keys: keys, spheres, codon rings
  â”‚     â””â”€â”€ Shared: lines, numerology, chakras, hermetic
  â”‚
  â””â”€â”€ Profile entities (~100-150 per profile): registered/cleared on profile switch
        â”œâ”€â”€ Astrology placements (10-12)
        â”œâ”€â”€ Astrology aspects (15-30)
        â”œâ”€â”€ Gene Key spheres (15)
        â”œâ”€â”€ HD gate activations (18-22)
        â””â”€â”€ HD defined channels (3-10)
```

### 9.2 Search Index

- Maps lowercase terms â†’ Set of entity IDs
- Supports: exact match, prefix match, fuzzy name matching
- Populated during registration, cleared on profile unregister
- Used by: SearchBar (Cmd+K), EntityPicker, AI context building

---

## 10. Cross-Tradition Data Bridges

### 10.1 The Degree Bridge (Core Unification)

The same ecliptic longitude (0-360) simultaneously identifies:
- **Astrology:** Which sign (30 segments) + degree within sign
- **Human Design:** Which gate (64 segments of ~5.625 each) + line (1-6)
- **Gene Keys:** Which key (1:1 with gate number) + line (1-6)

```
Planet at 225.5Â° ecliptic
  â”œâ”€â”€ Astrology: Scorpio 15Â°30' (225.5 / 30 = sign 7 = Scorpio, 225.5 % 30 = 15.5Â°)
  â”œâ”€â”€ Human Design: Gate 1, Line 3 (degreeStart: 223.25, degreeEnd: 228.87)
  â””â”€â”€ Gene Keys: Gene Key 1.3 (Shadow: Entropy â†’ Gift: Freshness â†’ Siddhi: Beauty)
```

### 10.2 Key Mapping Tables

| Bridge | From | To | Cardinality | Mechanism |
|--------|------|-----|-------------|-----------|
| Gate â†” Gene Key | HD Gate 1-64 | GK 1-64 | 1:1 | I Ching hexagram number |
| Sign â†” House | Sign (natural zodiac) | House 1-12 | 1:1 | Aries=H1, Taurus=H2, etc. |
| Sign â†” Chakra | Sign | Chakra 1-7 | N:1 | cross-tradition-map.json |
| House â†” Life Area | House 1-12 | ILOS Key Area | 1:1 | area-house-bridge.json |
| Planet â†” Element | Planet | fire/earth/air/water | N:1 | planetElementMap in colors.ts |
| Chakra â†” HD Center | Chakra | HD Center | N:N | chakra.relatedHDCenters |

### 10.3 I Ching Hexagram Identity

The I Ching hexagram number (1-64) is the universal key connecting:
- **HD Gate number** (gate-1 through gate-64)
- **Gene Key number** (gk-1 through gk-64)
- **I Ching hexagram name** (from traditional I Ching)
- **Codon Ring membership** (21 rings grouping related keys)

---

*Document Version: 1.0 â€” Phase 2 of 10 (Brownfield Discovery)*
*Next: Phase 4 (@architect â€” Technical Debt Draft) using Phase 1 + 2 + 3 findings*

â€” Dara, arquitetando dados ğŸ—„ï¸
