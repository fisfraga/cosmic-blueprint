# Database Audit ‚Äî Cosmic Blueprint
**Generated by:** @data-engineer (Dara) ‚Äî Brownfield Discovery Phase 2
**Date:** 2026-02-20
**Workflow:** brownfield-discovery v2.0
**Status:** Phase 2 Complete
**Companion Document:** `SCHEMA.md` (full schema documentation)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Critical Findings (CRITICAL)](#2-critical-findings)
3. [High-Severity Findings (HIGH)](#3-high-severity-findings)
4. [Medium-Severity Findings (MEDIUM)](#4-medium-severity-findings)
5. [Low-Severity Findings (LOW)](#5-low-severity-findings)
6. [Schema Integrity Audit](#6-schema-integrity-audit)
7. [RLS Policy Audit](#7-rls-policy-audit)
8. [Sync Architecture Audit](#8-sync-architecture-audit)
9. [Calculation Pipeline Audit](#9-calculation-pipeline-audit)
10. [Type System Audit](#10-type-system-audit)
11. [Recommendations Summary](#11-recommendations-summary)

---

## 1. Executive Summary

**Scope:** Full data layer audit covering Supabase schema (4 tables, 5 migrations), localStorage persistence (4 keys), sync architecture (4 domains), core calculation pipeline, and TypeScript type system.

### Severity Distribution

| Severity | Count | Category |
|----------|-------|----------|
| CRITICAL | 3 | Timezone handling, write error handling, migration column mismatch |
| HIGH | 5 | Retrograde calculation, silent sync failures, deleted data reappearance, no conflict resolution, focus_entity type inconsistency |
| MEDIUM | 5 | Missing FK constraint, missing `public.` prefix, no retry mechanism, focus_entity type mismatch in DB, no calculation caching |
| LOW | 4 | DB size estimation, house system not stored, index strategy gaps, JSONB vs versioned schema |

**Overall Assessment:** The local-first architecture is well-designed and the schema is appropriate for the current single-user scope. However, **data correctness is compromised by two CRITICAL issues** (timezone handling and write error handling) that should be addressed before any production deployment. The sync layer has multiple reliability gaps that will cause data loss scenarios.

---

## 2. Critical Findings

### CRIT-01: Timezone Handling Ignores Birth Location Timezone

**Location:** `src/services/chartCalculation.ts:563-572` (`parseBirthToUTC()`)

**Finding:** The function receives `birthData.timezone` but never uses it. Instead, it parses the birth datetime string using `new Date()`, which interprets the time in the **browser's current timezone**, not the birth location timezone.

```typescript
// Line 565-571 (simplified)
const dateTimeStr = `${birthData.dateOfBirth}T${birthData.timeOfBirth}:00`;
// Comment: "This is simplified - for production, use a proper timezone library"
const localDate = new Date(dateTimeStr);
// Comment: "Return as-is for now - proper implementation would use Intl or luxon"
```

**Impact:** All chart calculations (natal positions, design date, HD gate activations, Gene Key assignments) may be incorrect by up to +/- 12 hours depending on user's browser timezone vs birth timezone. For Moon position (moves ~13¬∞/day), this can mean wrong sign, wrong gate, wrong Gene Key.

**Recommendation:** Implement proper timezone conversion using `Intl.DateTimeFormat` or `luxon`. The `birthData.timezone` field already exists ‚Äî it just needs to be used.

---

### CRIT-02: Zero Error Handling on Cloud Write Operations

**Location:** All 4 sync files: `profileSync.ts:36-43,53`, `insightSync.ts:30-40,50`, `sessionSync.ts:30-39,49`, `pathwaySync.ts:34-44`

**Finding:** All Supabase upsert and delete operations have **no error checking whatsoever**. The `await supabase.from(...).upsert()` calls are fire-and-forget with no `.then()` check or try/catch.

```typescript
// Example from profileSync.ts (identical pattern in all 4 files)
await supabase.from('cosmic_profiles').upsert({
  id: profile.meta.id,
  user_id: user.id,
  name: profile.meta.name,
  profile_data: profile,
  is_active: profile.meta.id === activeId
});
// No error check ‚Äî failure is completely silent
```

**Impact:** Users may believe their data is synced to the cloud when it isn't. If a write fails (network error, RLS violation, constraint violation), the user has no way to know. Data loss occurs silently.

**Recommendation:** Add error checking on all write operations. At minimum: log failures and expose a sync status indicator in the UI. Preferred: implement a write queue with retry.

---

### CRIT-03: Migration 005 Column Name Mismatch

**Location:** `supabase/migrations/005_insight_indexes.sql:7-8`

**Finding:** The migration creates an index on column `type`, but the actual column name is `contemplation_type`:

```sql
-- Migration 005
CREATE INDEX IF NOT EXISTS idx_saved_insights_type ON saved_insights(type);
-- Actual column (from migration 001): contemplation_type TEXT NOT NULL
```

**Impact:** If this migration was applied, it either:
- (a) Created an index on a non-existent column ‚Üí migration failed (Supabase would error)
- (b) Was never actually applied ‚Üí the index doesn't exist

Either way, the `contemplation_type` column lacks the intended index, potentially impacting query performance on type-based filters.

**Recommendation:** Create a new migration (006) that drops the incorrect index (if it exists) and creates the correct one:
```sql
DROP INDEX IF EXISTS idx_saved_insights_type;
CREATE INDEX IF NOT EXISTS idx_saved_insights_type ON saved_insights(contemplation_type);
```

---

## 3. High-Severity Findings

### HIGH-01: Retrograde Status Always Returns False

**Location:** `src/services/chartCalculation.ts:126`

**Finding:** All planets except Earth are hardcoded to `retrograde: false` with a TODO comment:

```typescript
retrograde: false, // TODO: Calculate retrograde status
```

**Impact:** Natal chart displays never show retrograde planets. This is a significant astrological inaccuracy ‚Äî retrograde planets are fundamental to chart interpretation and affect the Contemplation Chamber AI's readings. Mercury, Venus, Mars, Jupiter, and Saturn are retrograde for significant portions of the year.

**Recommendation:** Calculate retrograde by comparing today's position to yesterday's position. If ecliptic longitude decreased (accounting for 360¬∞‚Üí0¬∞ wraparound), the planet is retrograde. The ephemeris data already supports daily lookups.

---

### HIGH-02: Silent Sync Failures on Cloud Read

**Location:** All 4 sync files: `profileSync.ts:69`, `insightSync.ts:66`, `sessionSync.ts:65`, `pathwaySync.ts:60`

**Finding:** Cloud fetch operations silently return empty arrays on error:

```typescript
if (error || !data) return [];
```

No error is logged, no user notification occurs. The merge operation then proceeds, potentially treating the user's cloud data as empty.

**Impact:** If a cloud read fails during sign-in merge:
1. Merge sees 0 cloud items ‚Üí nothing downloaded
2. All local items pushed to cloud ‚Üí OK
3. But any cloud-only items (from other devices) are invisible
4. User thinks sync completed successfully

**Recommendation:** Log errors, surface sync status to UI, and distinguish "no items" from "fetch failed".

---

### HIGH-03: Deleted Data Reappears After Sign-In

**Location:** All 4 sync merge algorithms

**Finding:** The additive-only merge pattern means:
1. User deletes item locally
2. User signs out
3. Item still exists in cloud (delete was pushed, but if sign-in happens before delete sync...)
4. User signs in ‚Üí merge downloads cloud copy ‚Üí item reappears locally

**Impact:** Users cannot reliably delete data. Items deleted on one device reappear when signing in on another. This creates a confusing user experience.

**Recommendation:** Either:
- (a) Implement soft deletes (`deleted_at` timestamp) so merge can respect deletions
- (b) Add a `deleted_ids` tracking set per domain
- (c) Use `updated_at` comparison for true last-write-wins merge

---

### HIGH-04: No Conflict Resolution for Multi-Device Edits

**Location:** All 4 sync merge algorithms

**Finding:** When the same item exists both locally and in the cloud (by ID), the merge does nothing ‚Äî neither version wins. The item stays as-is in both locations. This means edits on device A are invisible on device B if both already have the item.

**Impact:** Multi-device users see stale data. Profile updates, new session messages, pathway progress changes ‚Äî none are synced if the item already exists on both sides.

**Recommendation:** Compare `updatedAt` timestamps and take the newer version. Or implement proper CRDT merge for complex objects like sessions (message arrays).

---

### HIGH-05: focus_entity Type Inconsistency Between Domains

**Location:** `SavedInsight.focusEntity` (string) vs `SavedSession.focusEntity` (FocusEntity object)

**Finding:**
- `SavedInsight.focusEntity`: `string | undefined` ‚Äî stores entity ID as plain string
- `SavedSession.focusEntity`: `FocusEntity | null` ‚Äî stores full typed object with `type`, `id`, `name`, `transitData`, `entitySystem`
- Supabase: `saved_insights.focus_entity` is `TEXT`, `contemplation_sessions.focus_entity` is `JSONB`

Type casting in sync files:
```typescript
// insightSync.ts:75 ‚Äî treats as string
focusEntity: (row.focus_entity as string | null) ?? undefined,

// sessionSync.ts:71 ‚Äî treats as object
focusEntity: (row.focus_entity as SavedSession['focusEntity']) ?? null,
```

**Impact:** If insights need to reference back to their entity for navigation or context, the string-only ID in insights loses the entity type, system, and transit data that sessions preserve. Inconsistency makes cross-referencing between insights and sessions harder.

**Recommendation:** Standardize on the `FocusEntity` object type for both domains, or create a slim `FocusEntityRef` type with `id` + `type` + `entitySystem` for both.

---

## 4. Medium-Severity Findings

### MED-01: Missing FK Constraint (session_id in saved_insights)

**Location:** `saved_insights.session_id` ‚Äî TEXT column with no foreign key

**Finding:** `session_id` conceptually references `contemplation_sessions.id` but has no FK constraint. Orphaned insights (referencing deleted sessions) can exist.

**Recommendation:** Add FK in a new migration, or accept orphans as a design choice (insights outlive their source session).

---

### MED-02: Missing `public.` Schema Prefix on contemplation_sessions

**Location:** `supabase/migrations/003_contemplation_sessions.sql:5`

**Finding:** Table created as `contemplation_sessions` without `public.` prefix, while other 3 tables use `public.saved_insights`, `public.cosmic_profiles`, `public.pathway_progress`.

**Impact:** In Supabase, tables default to `public` schema, so this works. But it's inconsistent and could cause confusion if a different `search_path` is ever configured.

**Recommendation:** Fix in next migration with `ALTER TABLE contemplation_sessions SET SCHEMA public;` or simply document the inconsistency.

---

### MED-03: No Retry Mechanism for Sync Operations

**Location:** All 4 sync files

**Finding:** All sync operations are single-attempt. No exponential backoff, no queue, no retry. A transient network failure means data doesn't sync and the user is never notified.

**Recommendation:** Implement a lightweight retry queue (3 attempts, exponential backoff) for write operations.

---

### MED-04: focus_entity Column Type Mismatch Between Tables

**Location:** `saved_insights.focus_entity` (TEXT) vs `contemplation_sessions.focus_entity` (JSONB)

**Finding:** Same conceptual field stored as different types across tables. This makes cross-table queries and joins on `focus_entity` impossible.

**Recommendation:** Standardize to JSONB in both tables (requires migration for `saved_insights`).

---

### MED-05: No Calculation Caching

**Location:** `src/services/chartCalculation.ts`

**Finding:** Design date calculation (binary search, 20 ephemeris lookups) runs every time a profile is loaded. The `CalculatedChart` is stored in the profile, but only if saved back to localStorage.

**Recommendation:** Ensure `CalculatedChart` is always persisted after first calculation. Add a `calculatedAt` timestamp to enable cache invalidation.

---

## 5. Low-Severity Findings

### LOW-01: No Estimated Database Size Monitoring

**Finding:** No monitoring or alerting for localStorage or Supabase storage usage. localStorage has a ~5-10MB limit.

**Recommendation:** Add a storage usage indicator in settings/profile page.

---

### LOW-02: House System Not Stored

**Finding:** Placidus house system is assumed but never stored in the profile. If a different house system is ever supported, existing profiles can't indicate which system was used.

**Recommendation:** Add `houseSystem: 'placidus'` to `CalculatedChart` type.

---

### LOW-03: Index Strategy Gaps

**Finding:**
- No compound index on `saved_insights(user_id, category)` ‚Äî common filter pattern
- No compound index on `saved_insights(user_id, contemplation_type)` ‚Äî common filter pattern
- No index on `contemplation_sessions(category)` ‚Äî used in filtering

**Recommendation:** Add compound indexes based on actual query patterns once traffic data is available.

---

### LOW-04: JSONB vs Versioned Schema for profile_data

**Finding:** `cosmic_profiles.profile_data` stores the entire `CosmicProfile` as JSONB. This is flexible but means:
- No column-level indexing on profile fields
- No constraint validation at DB level
- Schema evolution managed entirely in TypeScript (v1‚Üív2 migration)

**Assessment:** JSONB is the correct choice for the current architecture. The profile is read/written as a unit, never queried by sub-fields at the DB level. The TypeScript migration system handles schema evolution adequately.

---

## 6. Schema Integrity Audit

| Check | Status | Notes |
|-------|--------|-------|
| All tables have PK | PASS | TEXT PKs on all 4 tables |
| All tables have `created_at` | PASS | TIMESTAMPTZ NOT NULL DEFAULT NOW() |
| All tables have `updated_at` | PASS | TIMESTAMPTZ with trigger |
| `updated_at` trigger exists | PASS | `handle_updated_at()` on all 4 tables |
| User FK to `auth.users` | PASS | All 4 tables, CASCADE delete |
| RLS enabled | PASS | All 4 tables |
| Unique constraints where needed | PASS | `cosmic_profiles(user_id) WHERE is_active`, `pathway_progress(user_id, pathway_id)` |
| NOT NULL on required fields | PASS | All required fields have NOT NULL |
| Default values appropriate | PASS | Arrays default to `{}`, JSONB defaults present |
| Migration idempotency | PASS | All use `IF NOT EXISTS` / `IF EXISTS` |
| No destructive operations | PASS | No DROP statements |
| Column name consistency | FAIL | Migration 005 references `type` instead of `contemplation_type` |
| Schema prefix consistency | FAIL | `contemplation_sessions` missing `public.` prefix |

---

## 7. RLS Policy Audit

### Coverage Matrix

| Table | SELECT | INSERT | UPDATE | DELETE | Gap? |
|-------|--------|--------|--------|--------|------|
| saved_insights | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | None |
| cosmic_profiles | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | None |
| pathway_progress | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | None |
| contemplation_sessions | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | `auth.uid() = user_id` | None |

**Assessment:** RLS is **complete and consistent** across all 4 tables. All operations are scoped to `auth.uid() = user_id`. No admin access patterns, no shared access ‚Äî appropriate for single-user design.

### Edge Cases Considered

| Scenario | Risk | Assessment |
|----------|------|------------|
| Profile sharing (future feature) | Would require new RLS policies | Not needed currently |
| Admin access | Would need service role key or admin policy | Not needed currently |
| Anonymous users | `auth.uid()` returns NULL ‚Üí no access | Correct behavior |
| Cross-user data access | Blocked by RLS | Verified |

---

## 8. Sync Architecture Audit

### Operation Safety Matrix

| Operation | Error Handling | Retry | User Notification | Data Loss Risk |
|-----------|---------------|-------|-------------------|----------------|
| Cloud read (fetch) | Silent empty return | None | None | Items invisible |
| Cloud write (upsert) | None | None | None | Data not persisted |
| Cloud delete | None | None | None | Item persists in cloud |
| Sign-in merge | Depends on read | None | None | Stale data |
| Profile push | None | None | None | Profile changes lost |

### Merge Algorithm Assessment

| Aspect | Current | Recommended |
|--------|---------|-------------|
| Conflict detection | None | Compare `updatedAt` timestamps |
| Merge strategy | Additive (never delete) | Last-write-wins with soft delete |
| Failure mode | Silent | Log + UI indicator |
| Retry | None | 3 attempts, exponential backoff |
| Offline queue | None | IndexedDB queue (future) |

---

## 9. Calculation Pipeline Audit

| Calculation | Correctness | Notes |
|-------------|-------------|-------|
| Ephemeris lookup | GOOD | O(1), pre-computed, fallback to astronomy-engine |
| Sign from longitude | GOOD | Simple division, well-tested |
| Gate from longitude | GOOD | Linear search, correct ranges |
| Design date (Sun -88¬∞) | GOOD | Binary search, 20 iterations, adequate precision |
| HD type determination | ACCEPTABLE | Simplified motor-to-throat check |
| HD authority | ACCEPTABLE | Follows center hierarchy |
| HD profile (lines) | GOOD | Derived from Sun personality/design |
| Gene Keys assignment | GOOD | 15 spheres correctly mapped from natal/design |
| Retrograde status | BROKEN | Always returns false |
| Timezone conversion | BROKEN | Uses browser timezone, ignores birth timezone |
| Natal aspects | GOOD | Pairwise calculation with configurable orbs |
| Transit aspects | GOOD | Transit-to-natal comparison |

---

## 10. Type System Audit

| Inconsistency | Location | Severity |
|---------------|----------|----------|
| `focusEntity`: string vs FocusEntity | SavedInsight vs SavedSession | HIGH |
| `focus_entity`: TEXT vs JSONB | saved_insights vs contemplation_sessions | MEDIUM |
| `EntityType` union (49 types) vs `FocusEntity.type` (10 types) | types/index.ts vs context.ts | LOW ‚Äî intentional subset |
| Profile v1 (`AstroProfile`) still in types | types/index.ts | LOW ‚Äî migration path exists |
| `BirthData.timezone` typed but unused | types/index.ts + chartCalculation.ts | CRITICAL ‚Äî see CRIT-01 |

---

## 11. Recommendations Summary

### Priority 1 ‚Äî Fix Before Production (CRITICAL + HIGH)

| # | Finding | Effort | Impact |
|---|---------|--------|--------|
| CRIT-01 | Implement timezone-aware birth time conversion | 2-4h | Calculation correctness |
| CRIT-02 | Add error handling on all Supabase write operations | 1-2h | Data reliability |
| CRIT-03 | Fix migration 005 column name (`type` ‚Üí `contemplation_type`) | 15min | Index effectiveness |
| HIGH-01 | Implement retrograde calculation | 1-2h | Astrological accuracy |
| HIGH-02 | Add error logging + UI sync status indicator | 2-3h | User trust |
| HIGH-05 | Standardize focusEntity type across domains | 1-2h | Type safety |

### Priority 2 ‚Äî Fix For Multi-Device Support (HIGH)

| # | Finding | Effort | Impact |
|---|---------|--------|--------|
| HIGH-03 | Implement soft deletes or delete tracking | 4-8h | Delete reliability |
| HIGH-04 | Implement timestamp-based conflict resolution | 4-8h | Multi-device sync |
| MED-03 | Add retry mechanism for sync writes | 2-4h | Sync reliability |

### Priority 3 ‚Äî Improve Over Time (MEDIUM + LOW)

| # | Finding | Effort | Impact |
|---|---------|--------|--------|
| MED-01 | Add FK constraint on session_id | 15min | Referential integrity |
| MED-02 | Standardize schema prefix | 15min | Consistency |
| MED-04 | Standardize focus_entity column type | 30min + migration | Cross-table queries |
| MED-05 | Persist CalculatedChart cache | 1h | Performance |
| LOW-02 | Add houseSystem to CalculatedChart | 15min | Future-proofing |
| LOW-03 | Add compound indexes | 30min | Query performance |

### Estimated Total Remediation

| Priority | Hours | Stories |
|----------|-------|---------|
| P1 (Pre-Production) | 8-15h | 2-3 stories |
| P2 (Multi-Device) | 10-20h | 2-3 stories |
| P3 (Improvements) | 3-5h | 1 story |

---

*Document Version: 1.0 ‚Äî Phase 2 of 10 (Brownfield Discovery)*
*Companion: `SCHEMA.md` (full schema documentation)*
*Next: Phase 4 (@architect ‚Äî Technical Debt Draft) using Phase 1 + 2 + 3 findings*

‚Äî Dara, arquitetando dados üóÑÔ∏è
