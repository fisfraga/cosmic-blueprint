# System Architecture — Cosmic Blueprint
**Generated by:** @architect (Aria) — Brownfield Discovery Phase 1
**Date:** 2026-02-20
**Workflow:** brownfield-discovery v2.0
**Status:** Phase 1 Complete — Awaiting specialist review

---

## 1. Project Overview

**Cosmic Blueprint** (package name: `cosmic-copilot`) is a "digital temple for self-discovery" — an AI-powered knowledge graph explorer and personal contemplation platform integrating three wisdom traditions through a single birth moment.

| Attribute | Value |
|-----------|-------|
| Repository | https://github.com/fisfraga/cosmic-blueprint (private) |
| Version | 0.1.0 |
| Git Root | `/Users/fisfraga/Code/cosmic-blueprint-dev/cosmic-blueprint/` |
| Supabase Project | `ykuhdxrttxzualqysgtr.supabase.co` |
| Deployment Target | Vercel (serverless + SPA) |
| CI/CD | GitHub Actions (`.github/workflows/`) |
| Completed Sprints | G, G.5, H, I, J |

---

## 2. Technology Stack

### Core Dependencies

| Library | Version | Purpose |
|---------|---------|---------|
| React | 18.2.0 | UI framework |
| TypeScript | 5.2.2 (strict) | Type system |
| Vite | 5.0.8 | Build tool + dev server |
| Tailwind CSS | 3.3.6 | Utility-first CSS |
| D3.js | 7.8.5 | Data visualizations (mandala, force graph) |
| Framer Motion | 10.16.16 | Animations |
| Zustand | 4.4.7 | State management (**listed but NOT USED** — see tech debts) |
| React Router | 6.20.0 | Client-side routing |
| `astronomy-engine` | 2.1.19 | Ephemeris calculations (fallback) |
| `@anthropic-ai/sdk` | 0.71.2 | Anthropic API client |
| `@supabase/supabase-js` | 2.97.0 | Database + Auth client |

### Dev Dependencies (key)

| Library | Version | Purpose |
|---------|---------|---------|
| Vitest | 3.2.4 | Test runner |
| @testing-library/react | 16.3.2 | Component testing |
| ESLint | 8.55.0 | Linting |
| `@vercel/node` | 5.5.27 | Vercel serverless type support |
| jsdom | 27.0.1 | DOM simulation for tests |

### Version Drift Observations

| Dependency | Current | Latest (Feb 2026) | Gap |
|------------|---------|------------------|-----|
| TypeScript | 5.2.2 | 5.7.x | 2 minor versions |
| Framer Motion | 10.16.16 | v11 | 1 major version |
| ESLint | 8.55.0 | v9 | 1 major version |
| React | 18.2.0 | 18.3.x | 1 patch |
| Zustand | 4.4.7 | 4.5.x | 1 minor |
| `@anthropic-ai/sdk` | 0.71.2 | verify | Needs audit |

---

## 3. Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                     USER BROWSER                             │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │               React SPA (Vite Bundle)                 │  │
│  │                                                      │  │
│  │  ┌──────────┐  ┌──────────┐  ┌────────────────────┐ │  │
│  │  │  Pages   │  │Components│  │   Context (Auth +   │ │  │
│  │  │  (70+)   │  │   (24)   │  │   Profile)          │ │  │
│  │  └────┬─────┘  └────┬─────┘  └────────────────────┘ │  │
│  │       │             │                                 │  │
│  │  ┌────▼─────────────▼──────────────────────────────┐ │  │
│  │  │              Services Layer (25 files)           │ │  │
│  │  │  chartCalculation │ ephemeris │ contemplation/   │ │  │
│  │  │  transits │ aspects │ profiles │ insights │ sync │ │  │
│  │  └────────────────────────────────────────────────┘ │  │
│  │                                                      │  │
│  │  ┌─────────────────────────────────────────────────┐ │  │
│  │  │           Data Layer                             │ │  │
│  │  │  universal/ (29 JSON) │ ephemeris/ (pre-computed)│ │  │
│  │  │  knowledge/ │ ilos/ │ profile/                   │ │  │
│  │  └─────────────────────────────────────────────────┘ │  │
│  │                                                      │  │
│  │  ┌─────────────────┐  ┌──────────────────────────┐  │  │
│  │  │   localStorage   │  │  Supabase Client (optional)│ │  │
│  │  │ (primary store)  │  │  Auth + Cloud Sync        │  │  │
│  │  └─────────────────┘  └──────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP
     ┌───────────────┼───────────────────┐
     ▼               ▼                   ▼
┌─────────┐   ┌────────────┐    ┌─────────────────┐
│ Vercel  │   │  Supabase  │    │  OpenRouter API  │
│ api/    │   │  Database  │    │  (dev proxy)     │
│ claude  │   │  + Auth    │    │                  │
│.ts (SSF)│   │            │    │                  │
└────┬────┘   └────────────┘    └─────────────────┘
     │
     ▼
┌─────────────────┐
│  Anthropic API  │
│  (production)   │
└─────────────────┘
```

---

## 4. Directory Structure

```
cosmic-blueprint/
├── api/
│   └── claude.ts              # Vercel serverless function (production AI proxy)
├── src/
│   ├── App.tsx                # Root router — 85+ lazy-loaded routes
│   ├── main.tsx               # Entry point
│   ├── types/
│   │   └── index.ts           # All TypeScript interfaces (EntityType, AstroEntity, etc.)
│   ├── context/
│   │   ├── AuthContext.tsx    # Supabase auth state
│   │   ├── ProfileContext.tsx # Active profile state (multi-profile support)
│   │   └── index.ts
│   ├── lib/
│   │   └── supabase.ts        # Supabase client (optional — graceful degradation)
│   ├── data/
│   │   ├── universal/         # 29 JSON knowledge base files
│   │   ├── ephemeris/
│   │   │   └── positions-2020-2035.json  # Pre-computed daily positions
│   │   ├── knowledge/         # AI context excerpts by tradition
│   │   │   ├── astrology/
│   │   │   ├── gene-keys/
│   │   │   ├── human-design/
│   │   │   ├── chakras/
│   │   │   ├── numerology/
│   │   │   ├── alchemy/
│   │   │   └── integration/
│   │   ├── ilos/              # Intentional Life OS context for AI
│   │   │   ├── active-snapshot.json
│   │   │   ├── area-house-bridge.json
│   │   │   ├── methodology.json
│   │   │   └── personal-context.json
│   │   ├── profile/
│   │   │   └── felipe.json    # Seed profile (developer data)
│   │   └── index.ts           # Unified data export (Maps + utilities)
│   ├── services/
│   │   ├── chartCalculation.ts    # Core calculation pipeline (641L)
│   │   ├── ephemeris.ts           # Planetary position lookup (239L)
│   │   ├── aspects.ts             # Aspect calculation (213L)
│   │   ├── aspects.test.ts        # Only test file in project (256L)
│   │   ├── transits.ts            # Transit positions + cosmic weather (548L)
│   │   ├── transitAspects.ts      # Transit-to-natal aspects (345L)
│   │   ├── astrologyAPI.ts        # FreeAstroAPI integration (379L)
│   │   ├── contemplation/         # AI system (3,515L total)
│   │   │   ├── context.ts         # System prompt builder (1,463L)
│   │   │   ├── prompts.ts         # Persona/prompt templates (1,801L)
│   │   │   └── ilos.ts            # ILOS → AI context bridge (248L)
│   │   ├── profiles.ts            # Profile CRUD (localStorage) (233L)
│   │   ├── profileMigration.ts    # v1→v2 format migration (189L)
│   │   ├── profileValidation.ts   # Profile validation (501L)
│   │   ├── profileEnrichment.ts   # Enrichment post-calculation (204L)
│   │   ├── profileDataParser.ts   # External API data parsing (770L)
│   │   ├── profileSync.ts         # localStorage ↔ Supabase sync (103L)
│   │   ├── insights.ts            # Insight CRUD (localStorage) (113L)
│   │   ├── insightSync.ts         # Insights ↔ Supabase sync (109L)
│   │   ├── sessions.ts            # Session CRUD (72L)
│   │   ├── sessionSync.ts         # Sessions ↔ Supabase sync (107L)
│   │   ├── pathways.ts            # Contemplation journeys (443L)
│   │   ├── pathwaySync.ts         # Pathways ↔ Supabase sync (99L)
│   │   ├── lifeAreas.ts           # Life areas / ILOS bridge (244L)
│   │   ├── tanaSync.ts            # Tana Paste format generators (183L)
│   │   ├── authService.ts         # Auth service (magic link) (60L)
│   │   ├── claude.ts              # Claude API client (221L)
│   │   ├── neutrinoWebhook.ts     # Neutrino webhook handler (227L)
│   │   └── entities/
│   │       └── registry.ts        # Unified entity search
│   ├── components/            # 24 shared components (~6,134L total)
│   ├── pages/                 # 70+ pages (~19,846L total)
│   └── styles/
├── supabase/
│   └── migrations/
│       ├── 001_initial_schema.sql
│       ├── 002_pathway_progress.sql
│       └── 003_contemplation_sessions.sql
├── docs/
│   ├── architecture/          # [this file]
│   └── context/               # Business context docs
├── api/
│   └── claude.ts              # Vercel Edge Function
├── vite.config.ts             # Build config + dev AI proxy
├── tailwind.config.js         # Element-based color theming
├── tsconfig.json              # TS config (strict, no paths)
└── vercel.json                # SPA rewrite rule only
```

---

## 5. Data Architecture

### 5.1 Universal Knowledge Base

29 JSON files in `src/data/universal/` loaded as typed Maps via `src/data/index.ts`:

| File | Entity Count | Type Key |
|------|-------------|----------|
| planets.json | 14 | `planet` |
| signs.json | 12 | `sign` |
| houses.json | 12 | `house` |
| elements.json | 4 (+alchemical) | `element` |
| aspects.json | ~10 | `aspect` |
| configurations.json | ~8 | `configuration` |
| hd-gates.json | 64 | `hd-gate` |
| hd-channels.json | 36 | `hd-channel` |
| hd-centers.json | 9 | `hd-center` |
| hd-types.json | 5 | `hd-type` |
| hd-authorities.json | 7 | `hd-authority` |
| hd-profiles.json | 12 | `hd-profile` |
| hd-lines.json | 6 | `hd-line` |
| hd-strategies.json | 5 | `hd-strategy` |
| hd-variables.json | 4 | `hd-variable` |
| gene-keys.json | 64 | `gene-key` |
| gk-spheres.json | 11 | `gk-sphere` |
| gk-sequences.json | 3 | `gk-sequence` |
| gk-lines.json | 6 | `gk-line` |
| codon-rings.json | 21 | `codon-ring` |
| amino-acids.json | 21 | `amino-acid` |
| trigrams.json | 8 | `trigram` |
| numerology.json | 11 | `numerology-number` |
| chakras.json | 7 | `chakra` |
| hermetic-principles.json | 7 | `hermetic-principle` |
| decans.json | 36 | `decan` |
| dignities.json | ~12 | `dignity` |
| lines.json | 6 | `line` (unified) |
| cross-tradition-map.json | bridge | mapping |

**Total: 29 files, 700+ entities**

### 5.2 Ephemeris Data

- **Primary:** `positions-2020-2035.json` — pre-computed daily planetary positions for fast lookups
- **Fallback:** `astronomy-engine` library for dates outside range
- All positions: geocentric ecliptic longitudes (0-360°)

### 5.3 Profile Storage Architecture

```
localStorage (PRIMARY)                    Supabase (CLOUD SYNC — optional)
├── cosmic-copilot-profiles              ├── public.cosmic_profiles
│   └── CosmicProfile[] (all)           │   └── profile_data JSONB
├── cosmic-copilot-active-profile-id    ├── public.saved_insights
├── cosmic-copilot-seeded               ├── public.pathway_progress
├── insights (key varies)               └── public.contemplation_sessions
├── pathway progress
└── contemplation sessions
```

**Pattern:** Local-first, Supabase as optional cloud backup. App fully functional without authentication.

---

## 6. Service Architecture

### 6.1 Core Calculation Pipeline

```
BirthData (date, time, location)
      │
      ▼
getPlanetaryPositions() [ephemeris.ts]
      │ Returns: ecliptic longitudes for 11 planets
      ▼
calculateChartFromBirthData() [chartCalculation.ts]
      │
      ├── Astrology: sign/house placement per planet
      ├── HD: gate activations from longitudes
      │   └── getGateByDegree() → HDGateActivation[]
      │       └── derives: type, authority, definition, channels
      ├── Gene Keys: sphere placements
      │   └── getGeneKeyByZodiacPosition()
      └── Numerology: life path, destiny, etc.
      │
      ▼
enrichProfile() [profileEnrichment.ts]
      │ Adds: aspects, configurations, transit data
      ▼
CosmicProfile (v2 format)
```

### 6.2 AI Contemplation System

```
ContemplationChamber.tsx (1,346L)
      │
      ▼
claude.ts (client service)
      │ POST /api/claude
      │
      ├── DEV: vite.config.ts claudeApiProxy() → OpenRouter
      └── PROD: api/claude.ts (Vercel SSF) → Anthropic API

Context Building [contemplation/context.ts — 1,463L]:
      ├── Profile data (all 3 traditions)
      ├── Current transits + transit-natal aspects
      ├── ILOS context (life areas, goals, methodology)
      ├── Knowledge excerpts [data/knowledge/]
      └── Contemplation type configuration

Prompt Templates [contemplation/prompts.ts — 1,801L]:
      ├── 6 personas: Guide, Teacher, Counselor, Analyzer, Embodiment, PARACELSUS
      ├── 32+ contemplation types
      └── 4 categories: Astrology, HD, Gene Keys, Cross-System
```

**⚠️ Proxy Discrepancy Noted:** CLAUDE.md documentation states the dev proxy connects to Anthropic API, but `vite.config.ts` actually proxies to **OpenRouter** (`https://openrouter.ai/api/v1/chat/completions`). Production uses Anthropic directly. This creates a potential model behavior difference between dev and production.

### 6.3 Sync Architecture

Each domain has a separate sync service following the pattern:

```
[domain]Sync.ts
  ├── push[Domain]ToCloud() — localStorage → Supabase
  └── pull[Domain]FromCloud() — Supabase → localStorage
```

4 sync domains: profiles, insights, sessions, pathways.

---

## 7. Frontend Architecture

### 7.1 Routing

App.tsx defines **85+ routes** — all pages are lazy-loaded via `React.lazy()` + `Suspense`. Route hierarchy:

```
/ (Layout shell)
├── / → Home
├── /wheel → CelestialMandala (D3)
├── /graph → ConstellationGraph (D3 force)
├── /contemplate → ContemplationChamber (AI)
├── /transits → Transits
├── /pathways → Pathways
├── /life-areas → LifeAreas
├── /profile → Profile (hub)
│   ├── /astrology → ProfileAstrology
│   ├── /gene-keys → ProfileGeneKeys
│   └── /human-design → ProfileHumanDesign
├── /planets, /signs, /houses, /elements, /aspects → knowledge lists
├── /gene-keys/, /human-design/ → HD/GK knowledge lists
├── /insights → InsightLibrary
├── /sessions → SessionsLibrary
└── /onboarding → Onboarding
```

### 7.2 State Management

**Actual state management (no Zustand):**

| Scope | Mechanism |
|-------|-----------|
| Auth state | `AuthContext` (React Context) |
| Active profile | `ProfileContext` (React Context) |
| All profiles | `ProfileContext.allProfiles` (derived from localStorage) |
| Page-level UI state | Component `useState` |
| Persistent data | `localStorage` |

**Zustand is listed as a dependency but is not imported or used anywhere in the codebase.** This is a dead dependency.

### 7.3 Element-Based Theming

`tailwind.config.js` defines 6 custom color scales:
- `fire`, `earth`, `air`, `water` — classical elements
- `humandesign` — amber/gold scale
- `genekey` — purple/violet scale
- `neutral` — dark background theme

Components derive color class from entity's `elementId` property.

### 7.4 Key Large Files

| File | Lines | Issue |
|------|-------|-------|
| `contemplation/prompts.ts` | 1,801 | Monolithic prompt store |
| `contemplation/context.ts` | 1,463 | Monolithic context builder |
| `pages/ContemplationChamber.tsx` | 1,346 | God component |
| `pages/Profile.tsx` | 1,202 | God component |
| `pages/Onboarding.tsx` | 742 | Large, could be split |
| `pages/Transits.tsx` | 694 | Large |
| `services/profileDataParser.ts` | 770 | Very large parser |

---

## 8. Database Architecture

### 8.1 Schema Overview

**4 tables, all with RLS (Row Level Security):**

| Table | Schema Prefix | Purpose |
|-------|--------------|---------|
| `saved_insights` | `public.` | Contemplation insights |
| `cosmic_profiles` | `public.` | User birth profiles |
| `pathway_progress` | `public.` | Journey progress |
| `contemplation_sessions` | **missing** | AI conversation history |

**⚠️ Schema Inconsistency:** Migration `003_contemplation_sessions.sql` creates the `contemplation_sessions` table **without the `public.` schema prefix**, unlike the other 3 tables. In Supabase/PostgreSQL this defaults to `public`, so it likely works, but represents an inconsistency.

### 8.2 Authentication

- **Method:** Magic link only (passwordless email OTP via Supabase Auth)
- **No** Google OAuth, GitHub OAuth, or other providers
- **Graceful degradation:** Supabase is optional — when `VITE_SUPABASE_URL` / `VITE_SUPABASE_ANON_KEY` are absent, auth features are hidden and app runs fully local

### 8.3 Indexes

| Table | Indexes |
|-------|---------|
| saved_insights | `user_id`, `(user_id, created_at DESC)` |
| cosmic_profiles | `user_id`, `(user_id) WHERE is_active = TRUE` (unique) |
| pathway_progress | `user_id`, `(user_id, pathway_id)` (unique) |
| contemplation_sessions | `user_id`, `(user_id, updated_at DESC)` |

### 8.4 Missing Database Features

- No `updated_at` trigger on `contemplation_sessions` — uses `handle_updated_at()` from migration 001, but the trigger exists (checked: migration 003 references it)
- No full-text search indexes
- No `category` or `contemplation_type` indexes on `saved_insights` (used in filtering)
- No `pathway_id` index on `pathway_progress` (only compound user+pathway)

---

## 9. Integration Points

| Integration | Type | Direction | Auth | Notes |
|-------------|------|-----------|------|-------|
| Anthropic API | REST | App → External | API Key (server-side) | Via Vercel SSF in prod |
| OpenRouter | REST | App → External | API Key | Dev proxy only |
| Supabase | SDK | Bidirectional | Anon key + JWT | Optional |
| FreeAstroAPI | REST | App → External | API Key (server-side) | VITE_ASTROLOGY_API_ENABLED |
| Tana (MCP) | Local MCP | App → External | None (local) | CLI only, via tanaSync.ts |

**⚠️ Dev/Prod Model Divergence:** Dev uses OpenRouter (can route to any model), production uses Anthropic API directly. The model used in dev is `anthropic/claude-sonnet-4-6` via OpenRouter. If OpenRouter routing changes or model aliases differ, behavior can diverge silently.

---

## 10. Deployment Architecture

### 10.1 Vercel Configuration

```json
{
  "rewrites": [{ "source": "/(.*)", "destination": "/" }]
}
```

**Issue:** `vercel.json` only has SPA catch-all. The `api/` directory is auto-detected by Vercel. No explicit route configuration for the `/api/claude` serverless function, which works but is implicit.

### 10.2 Environment Variables

| Variable | Scope | Required | Purpose |
|----------|-------|----------|---------|
| `ANTHROPIC_API_KEY` | Server (Vercel) | Yes | Production AI calls |
| `OPENROUTER_API_KEY` | Client (.env) | Dev only | Dev AI proxy |
| `VITE_SUPABASE_URL` | Client | Optional | Supabase connection |
| `VITE_SUPABASE_ANON_KEY` | Client | Optional | Supabase auth |
| `FREEASTRO_API_KEY` | Server (Vercel) | Optional | Natal chart API |
| `VITE_ASTROLOGY_API_ENABLED` | Client | Optional | Enable FreeAstroAPI |

---

## 11. Test Coverage

| Metric | Value | Target |
|--------|-------|--------|
| Test files | **1** (`aspects.test.ts`) | 25+ |
| Test lines | 256 | — |
| Services tested | 1 of 25 (4%) | 80%+ |
| Components tested | 0 of 24 (0%) | 50%+ |
| Pages tested | 0 of 70+ (0%) | Key flows |
| Integration tests | 0 | — |

**Critical gap:** `chartCalculation.ts` (641L, core business logic), `ephemeris.ts`, `profileMigration.ts`, and all sync services have zero test coverage.

---

## 12. Identified Technical Debts

### System-Level Debts

| ID | Debt | Severity | Area |
|----|------|----------|------|
| SYS-01 | Zustand listed as dependency but never imported/used | LOW | Dependencies |
| SYS-02 | OpenRouter (dev) vs Anthropic (prod) proxy divergence — silent model drift possible | MEDIUM | Architecture |
| SYS-03 | CLAUDE.md documentation states Anthropic proxy but code uses OpenRouter | LOW | Documentation |
| SYS-04 | TypeScript `@` path alias only in vite.config — not in tsconfig.json `paths` | MEDIUM | Build Config |
| SYS-05 | No global React Error Boundary in App.tsx | HIGH | Reliability |
| SYS-06 | Missing `.env.example` file — env vars only documented in CLAUDE.md | MEDIUM | DX |
| SYS-07 | Dependency versions: framer-motion v10 (v11 available, breaking), ESLint v8 (v9 available) | MEDIUM | Maintenance |
| SYS-08 | vercel.json missing explicit `/api/claude` route — relies on Vercel auto-detection | LOW | Deployment |
| SYS-09 | Hard-coded developer profile (felipe.json) seeded into all user instances | MEDIUM | Data/Privacy |
| SYS-10 | No offline/PWA strategy despite heavy localStorage usage | LOW | UX |

### Service-Level Debts

| ID | Debt | Severity | Area |
|----|------|----------|------|
| SVC-01 | **Critically low test coverage** — 1 test file for 25 services | CRITICAL | Quality |
| SVC-02 | `contemplation/context.ts` at 1,463 lines — monolithic, hard to test | HIGH | Maintainability |
| SVC-03 | `contemplation/prompts.ts` at 1,801 lines — monolithic, no separation by persona | HIGH | Maintainability |
| SVC-04 | `profileDataParser.ts` at 770 lines — single-responsibility violation | MEDIUM | Maintainability |
| SVC-05 | `chartCalculation.ts` (641L, core logic) has zero tests | CRITICAL | Quality |
| SVC-06 | Sync services (profileSync, insightSync, sessionSync, pathwaySync) — each 100-110L but follow identical patterns — prime candidate for abstraction | MEDIUM | Duplication |
| SVC-07 | No error recovery strategy in sync services — failed cloud sync is silent | HIGH | Reliability |
| SVC-08 | `localStorage` has no quota management — will fail silently at ~5MB | MEDIUM | Reliability |
| SVC-09 | `neutrinoWebhook.ts` (227L) — unclear ownership/purpose, needs documentation | LOW | Clarity |

### Frontend Debts

| ID | Debt | Severity | Area |
|----|------|----------|------|
| FE-01 | `ContemplationChamber.tsx` at 1,346 lines — God component | HIGH | Maintainability |
| FE-02 | `Profile.tsx` at 1,202 lines — God component | HIGH | Maintainability |
| FE-03 | 0 component tests out of 24 components | HIGH | Quality |
| FE-04 | `ProfileCreationForm.tsx` (624L) and `BodyGraph.tsx` (622L) — large components | MEDIUM | Maintainability |
| FE-05 | No loading states for lazy-loaded routes beyond generic "Loading..." text | LOW | UX |
| FE-06 | Auth and profile contexts are coupled — ProfileContext imports auth state | MEDIUM | Architecture |

### Database Debts

| ID | Debt | Severity | Area |
|----|------|----------|------|
| DB-01 | `contemplation_sessions` table missing `public.` schema prefix (migration 003) | LOW | Schema Consistency |
| DB-02 | No index on `saved_insights(category, contemplation_type)` — used in filtering | MEDIUM | Performance |
| DB-03 | No text search support on insights — full-text search requires `tsvector` index | MEDIUM | Features |
| DB-04 | `cosmic_profiles.profile_data` is JSONB — schema evolution not versioned | MEDIUM | Data Integrity |
| DB-05 | No UPDATE policy on `saved_insights` for tag editing? (verify — migration 001 shows UPDATE policy exists) | LOW | Security |
| DB-06 | Only magic link auth — no social login options | LOW | UX |
| DB-07 | No database backup/export mechanism documented | MEDIUM | Operations |

---

## 13. Integration Patterns

### 13.1 FreeAstroAPI (External)

Used for natal chart calculation (houses, aspects) when `VITE_ASTROLOGY_API_ENABLED=true`. Parsed by `profileDataParser.ts` (770L). The API is optional — app falls back to internal calculation when disabled.

### 13.2 Tana MCP Integration

`tanaSync.ts` generates Tana Paste format for syncing insights/sessions to the ILOS workspace. This is a **CLI-only integration** — no in-app Tana API calls. Users export via clipboard or the MCP tools in Claude Code.

### 13.3 Neutrino Webhook

`neutrinoWebhook.ts` (227L) — purpose unclear from file name alone. Needs investigation. May be related to Human Design neutrino stream data.

---

## 14. Questions for Specialist Review

### For @data-engineer (Dara): ✅ ANSWERED (Phase 2 Complete)

*Full analysis in `docs/architecture/SCHEMA.md` + `docs/architecture/DB-AUDIT.md`. Summary:*

1. **Missing `public.` prefix on `contemplation_sessions` — causing issues?**
   → **No immediate issues.** Supabase defaults to `public` schema, so the table resolves correctly. However, it's an inconsistency (other 3 tables use explicit `public.` prefix) and could cause confusion if `search_path` is ever modified. Classified as MED-02, fix is trivial (`ALTER TABLE` or document as accepted inconsistency).

2. **Should `saved_insights(category, contemplation_type)` have compound indexes?**
   → **Yes, eventually.** Currently only single-column indexes exist on `category` and `type` (and the `type` index has a **CRITICAL column name bug** — references `type` instead of `contemplation_type`, see DB-AUDIT CRIT-03). Compound indexes on `(user_id, category)` and `(user_id, contemplation_type)` would better serve the actual query patterns (always filtered by user_id via RLS + category/type). Classified as LOW-03 — add when traffic data justifies it.

3. **JSONB for `profile_data` — right choice?**
   → **Yes, correct choice for current architecture.** The profile is read/written as a complete unit, never queried by sub-fields at the DB level. JSONB provides flexibility for schema evolution (v1→v2 migration handled in TypeScript). Column-level constraints aren't needed since validation occurs in the app layer. If profile sub-field queries become needed (e.g., "find all Scorpio Sun users"), a materialized view or extracted columns approach would be appropriate then.

4. **RLS policies sufficient? Edge cases?**
   → **RLS is complete and sufficient for current scope.** All 4 tables have SELECT/INSERT/UPDATE/DELETE policies, all enforcing `auth.uid() = user_id`. No gaps detected. Edge cases considered: (a) **Profile sharing** — would require new RLS policies with a sharing/permissions table, not needed yet; (b) **Admin access** — would need service role key or admin-level policies, not needed yet; (c) **Anonymous users** — `auth.uid()` returns NULL → zero access, correct behavior.

5. **Missing UPDATE policy gap?**
   → **No gaps found.** All 4 tables have explicit UPDATE policies. RLS coverage is 4/4 operations × 4 tables = 16 policies, all present and consistent. However, there's a **more critical gap in the sync layer**: Supabase write operations (upsert/delete) have zero error handling in TypeScript (DB-AUDIT CRIT-02). RLS enforcement is correct at the DB level, but the app never checks if writes succeeded.

6. **Database size/growth rate for a typical user?**
   → **Estimated well within limits.** localStorage: ~2.5MB max (10 profiles × 100KB + 100 insights × 5KB + 20 sessions × 50KB + pathways). Browser limit is 5-10MB. Supabase: mirrors localStorage, so similar per-user footprint. Growth rate is bounded by hard caps (10 profiles, 100 insights, 20 sessions). The real size concern isn't storage but **JSONB payload size** — a single `cosmic_profiles.profile_data` row stores the entire `CosmicProfile` (~50-100KB JSONB), which could slow upserts. No monitoring exists currently (DB-AUDIT LOW-01).

### For @ux-design-expert (Uma): ✅ ANSWERED (Phase 3 Complete)

*Full answers in `docs/architecture/frontend-spec.md`. Summary:*

1. **ContemplationChamber (1,345L) and Profile (1,202L) — UX impact?**
   → Not causing visible UX issues yet (no reported performance/responsiveness problems), but they are **structural time bombs**. ContemplationChamber has 19 useState hooks — every state change re-renders the entire 1,345L tree. Recommend decomposition into ChatMessages + ChatInput + SessionManager sub-components.

2. **Element theming consistency across 70+ pages?**
   → **YES — excellent consistency.** Custom element colors (fire/earth/air/water/humandesign/genekey) total 761 instances, all using the centralized Tailwind config. Only 1 arbitrary color value found (`bg-[#9333EA]` in ProfileBodyGraph.tsx → should be `bg-genekey-600`). The color system is the strongest aspect of the design.

3. **D3 visualization accessibility?**
   → **CRITICAL gap.** All 5 D3 components (CelestialMandala, ConstellationGraph, BodyGraph, HouseSubstanceWheel, ChakraBodyViz) have **zero ARIA support** — no `role="img"`, no `aria-label`, no text alternatives. They are invisible to screen readers. Additionally, all 5 duplicate SVG setup, color maps, and interaction handlers with no shared utilities.

4. **Loading experience for lazy-loaded pages?**
   → **Adequate.** All routes use `<LoadingSkeleton variant="page" />` (155L component with 4 variants). This provides visual feedback during chunk loading. No ARIA live regions for loading states though (screen readers don't know loading is happening).

5. **Mobile responsiveness gaps?**
   → Mobile-first responsive design using `md:` breakpoints throughout. Grid layouts collapse properly (`grid-cols-1 md:grid-cols-2 lg:grid-cols-3`). Layout.tsx has hamburger menu for mobile nav. No critical gaps identified, though the D3 visualizations (CelestialMandala, BodyGraph) may not scale well on very small screens.

6. **Onboarding flow (742L) — UX friction?**
   → Main friction: **birth data form is duplicated** between Onboarding.tsx (StepBirthData, ~200L) and ProfileCreationForm.tsx (624L). Same fields, same validation, same coordinate parsing — two separate implementations. Recommend extracting a shared `BirthDataForm` molecule.

---

## 15. Strengths

- Clean TypeScript architecture with strict mode
- Excellent type system — 30+ EntityTypes with discriminated unions
- Smart ephemeris strategy — pre-computed fast path + library fallback
- Local-first approach — works without auth/network
- Graceful Supabase degradation — app fully functional offline
- Lazy loading for all 70+ pages — good initial bundle size
- RLS on all 4 tables — good security posture
- Element-based design system — consistent visual language
- Prompt caching consideration in Claude integration (mentioned in CLAUDE.md)
- Clear separation of local vs sync concerns per domain

---

*Document Version: 1.2 — Phases 1 + 2 + 3 of 10 (Brownfield Discovery)*
*Completed: Phase 1 (@architect), Phase 2 (@data-engineer), Phase 3 (@ux-design-expert)*
*Next: Phase 4 (@architect — Technical Debt Draft) using all 3 specialist reports*
*See also: `docs/architecture/frontend-spec.md` (Phase 3), `SCHEMA.md` + `DB-AUDIT.md` (Phase 2)*
