# Technical Debt Assessment — DRAFT
**Generated by:** @architect (Aria) — Brownfield Discovery Phase 4
**Date:** 2026-02-20
**Status:** DRAFT — Pending specialist review (Phases 5–7)
**Sources:** system-architecture.md (Phase 1), SCHEMA.md + DB-AUDIT.md (Phase 2), frontend-spec.md (Phase 3)

---

## Executive Summary (Preliminary)

Cosmic Blueprint is a well-conceived product with a clean domain model and strong local-first architecture. After 5 sprints (G through J), the codebase has accumulated technical debt primarily in three areas: **test coverage** (critical gap), **component size** (God components need decomposition), and **database design** (missing relational connections and indexes).

| Layer | Debts Found | Critical | High | Medium | Low |
|-------|-------------|----------|------|--------|-----|
| System/Architecture | 10 | 0 | 1 | 5 | 4 |
| Services | 9 | 2 | 3 | 3 | 1 |
| Frontend/UX | 18 | 0 | 7 | 7 | 4 |
| Database | 20 | 0 | 5 | 12 | 3 |
| **TOTAL** | **57** | **2** | **16** | **27** | **12** |

**Estimated total remediation effort:** 120–220 hours

---

## 1. Debts of System/Architecture

*(From Phase 1 — validated by @architect)*

| ID | Debt | Severity | Estimated Effort |
|----|------|----------|-----------------|
| SYS-01 | Zustand listed as dependency but never used | LOW | 0.5h |
| SYS-02 | Dev (OpenRouter) vs Prod (Anthropic) proxy — silent model drift possible | MEDIUM | 4h |
| SYS-03 | CLAUDE.md documents Anthropic proxy but code uses OpenRouter | LOW | 0.5h |
| SYS-04 | `@` path alias only in vite.config — missing from tsconfig.json `paths` | MEDIUM | 1h |
| SYS-05 | No global React Error Boundary in App.tsx | HIGH | 3h |
| SYS-06 | No `.env.example` file | MEDIUM | 1h |
| SYS-07 | Outdated deps: framer-motion v10, ESLint v8, TypeScript 5.2 | MEDIUM | 8h |
| SYS-08 | vercel.json — api route relies on auto-detection, no explicit config | LOW | 1h |
| SYS-09 | Hard-coded developer profile (felipe.json) seeded into all instances | MEDIUM | 3h |
| SYS-10 | No offline/PWA strategy despite heavy localStorage usage | LOW | — |

**Subtotal system effort:** 22h (low) – 32h (high)
**PENDENTE: Revisão do @data-engineer e @ux-design-expert**

---

## 2. Debts of Services

*(From Phase 1 — validated by @architect)*

| ID | Debt | Severity | Estimated Effort |
|----|------|----------|-----------------|
| SVC-01 | Only 1 test file across 25 services — 4% coverage | CRITICAL | 40–80h |
| SVC-02 | `contemplation/context.ts` at 1,463L — monolithic | HIGH | 8–16h |
| SVC-03 | `contemplation/prompts.ts` at 1,801L — monolithic | HIGH | 8–16h |
| SVC-04 | `profileDataParser.ts` at 770L — SRP violation | MEDIUM | 6–10h |
| SVC-05 | `chartCalculation.ts` (641L, core logic) — zero tests | CRITICAL | 8–16h |
| SVC-06 | 4 sync services (100-110L each) — identical pattern, prime for abstraction | MEDIUM | 4–8h |
| SVC-07 | No error recovery in sync services — failed sync is silent | HIGH | 4–8h |
| SVC-08 | localStorage has no quota management — silent fail at ~5MB | MEDIUM | 3–5h |
| SVC-09 | `neutrinoWebhook.ts` (227L) — unclear ownership/purpose | LOW | 1h |

**Subtotal service effort:** 82h (low) – 160h (high)
**PENDENTE: Revisão do @data-engineer**

---

## 3. Debts of Database

*(From Phase 2 — PENDENTE: Revisão do @data-engineer)*

| ID | Debt | Severity | Estimated Effort |
|----|------|----------|-----------------|
| DB-SD-01 | Missing `public.` on `contemplation_sessions` | LOW | 1h |
| DB-SD-02 | `profile_data` unversioned JSONB | MEDIUM | 3–6h |
| DB-SD-03 | `session_id` in insights — no FK to sessions | MEDIUM | 2h |
| DB-SD-04 | `focus_entity`: TEXT in insights vs JSONB in sessions | MEDIUM | 3h |
| DB-SD-05 | `messages` monolithic JSONB — no pagination | MEDIUM | 8–16h |
| DB-SD-06 | No `profile_id` FK in insights or sessions | HIGH | 6–12h |
| DB-IDX-01 | Missing index on `saved_insights(category, type)` | HIGH | 1h |
| DB-IDX-02 | No full-text search on insights | HIGH | 2–4h |
| DB-IDX-03 | No standalone `pathway_id` index | MEDIUM | 0.5h |
| DB-IDX-04 | No index on `sessions(category)` | MEDIUM | 0.5h |
| DB-SEC-01 | RLS policy naming inconsistency | LOW | 0.5h |
| DB-SEC-02 | Tags array — no validation constraints | MEDIUM | 1h |
| DB-SEC-03 | No rate limiting | MEDIUM | 4–8h |
| DB-DI-01 | No CHECK constraints on category/type | MEDIUM | 2h |
| DB-DI-02 | TEXT PKs — no format validation | MEDIUM | 8–20h |
| DB-DI-03 | pathway timestamps lack DEFAULT NOW() | HIGH | 1h |
| DB-AUTH-01 | Magic link only — no social login | MEDIUM | 3–6h |
| DB-AUTH-02 | No email domain allowlist | LOW | 1h |
| DB-OPS-01 | No backup/export strategy | HIGH | 4–8h |
| DB-OPS-02 | No Supabase CLI config | MEDIUM | 2h |

**Subtotal DB effort:** 28h (low) – 55h (high)

---

## 4. Debts of Frontend/UX

*(From Phase 3 — PENDENTE: Revisão do @ux-design-expert)*

| ID | Debt | Severity | Estimated Effort |
|----|------|----------|-----------------|
| UX-01 | No global Error Boundary | HIGH | 2h |
| UX-02 | D3 visualizations inaccessible (no ARIA, no keyboard nav) | HIGH | 16–32h |
| UX-03 | No `prefers-reduced-motion` | HIGH | 4–8h |
| UX-04 | No skip navigation link | HIGH | 1h |
| UX-05 | Route change focus management absent | HIGH | 3–6h |
| UX-06 | `ContemplationChamber.tsx` God component (1,346L) | HIGH | 8–16h |
| UX-07 | `Profile.tsx` God component (1,202L) | HIGH | 6–12h |
| UX-08 | Route suspense uses plain "Loading..." text | MEDIUM | 2h |
| UX-09 | No WCAG contrast audit | MEDIUM | 4–8h |
| UX-10 | Timezone list incomplete (~20 options) | MEDIUM | 2h |
| UX-11 | No geocoding — manual lat/lon | MEDIUM | 8–16h |
| UX-12 | Home.tsx uses raw Tailwind instead of design system | MEDIUM | 1h |
| UX-13 | `import * as d3` — full D3 bundle | MEDIUM | 4–8h |
| UX-14 | 29 JSON files bundled at startup | MEDIUM | 8–16h |
| UX-15 | Dead "Coming Soon" nav items | LOW | 1h |
| UX-16 | D3 viz fixed pixel sizes | LOW | 3–6h |
| UX-17 | Emoji icons without aria-hidden | LOW | 1h |
| UX-18 | Framer Motion v10 (v11 available) | LOW | 8–16h |

**Subtotal UX effort:** 82h (low) – 155h (high)

---

## 5. Preliminary Priority Matrix

### CRITICAL (Address Immediately)

| ID | Debt | Business Risk | Action |
|----|------|--------------|--------|
| SVC-01 | Only 1 test file, 4% coverage | HIGH — regressions ship undetected | Add test suite for core services |
| SVC-05 | `chartCalculation.ts` untested | HIGH — core business logic could silently break | Add unit tests with known birth data |

### HIGH (Address in Next 2 Sprints)

| ID | Debt | Business Risk |
|----|------|--------------|
| SYS-05 | No Error Boundary | App crashes to blank screen on any runtime error |
| UX-01 | No Error Boundary | Same |
| UX-06 | ContemplationChamber God component | Blocks AI feature development |
| UX-07 | Profile.tsx God component | Blocks profile feature development |
| DB-SD-06 | No profile_id FK | Multi-profile users see unsegregated history |
| DB-IDX-01 | Missing category index | Insight Library performance degrades at scale |
| DB-IDX-02 | No full-text search | Insight Library search scales poorly |
| DB-DI-03 | Pathway timestamps | Pathway sync can fail silently |
| DB-OPS-01 | No backup/export | GDPR/data loss risk |
| SVC-07 | Silent sync failures | Users lose data without knowing |
| UX-02 | D3 inaccessible | Legal accessibility risk |

### MEDIUM (Address in Next 1–3 Months)

Bulk of the remaining 27 MEDIUM items — see sections 1–4 above.

---

## 6. Perguntas para Especialistas

### Para @data-engineer:
1. Is the `contemplation_sessions` table actually created in `public` schema despite missing prefix? Any Supabase-specific behavior?
2. What is the realistic data growth rate? At what point do the missing indexes become critical?
3. Is the `session_messages` table extraction (DB-SD-05) a prerequisite for any other improvement?
4. Is `profile_id` FK (DB-SD-06) the single highest-value DB improvement for multi-profile users?
5. What is your estimate for the `TEXT → UUID` PK migration complexity (DB-DI-02)?

### Para @ux-design-expert:
1. Are the D3 accessibility issues (UX-02) a current user complaint or a proactive concern?
2. What is the actual mobile usage pattern — are users on mobile encountering the nav/viz issues?
3. Is the geocoding improvement (UX-11) a significant onboarding drop-off cause?
4. Should `ContemplationChamber.tsx` decomposition happen before or after the AI persona integrity protocol improvements?
5. What are the highest-impact quick wins from the UX side?

---

*Document Version: DRAFT 1.0 — Phase 4 of 10 (Brownfield Discovery)*
*Next: Phase 5 (@data-engineer review) + Phase 6 (@ux-design-expert review)*
