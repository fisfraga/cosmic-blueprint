# Technical Debt Assessment — FINAL
**Generated by:** @architect (Aria) — Brownfield Discovery Phase 8
**Date:** 2026-02-20
**Workflow:** brownfield-discovery v2.0
**Status:** FINAL — Approved by QA Gate (Phase 7)
**Incorporates:** Specialist reviews from @data-engineer (Phase 5), @ux-design-expert (Phase 6), QA gaps from @qa (Phase 7)

---

## Executive Summary

| Metric | Value |
|--------|-------|
| Total debts identified | **70** |
| Critical | **4** |
| High | **22** |
| Medium | **32** |
| Low | **12** |
| Estimated remediation effort | **200–330 hours** |
| Quick wins available (≤2h each) | **10 items / ~15 hours** |
| Sprints to address critical+high | **4–6 sprints** |

Cosmic Blueprint is a feature-rich, well-architected product with a clear domain model and strong product vision. The technical debt is **manageable and expected** for a product that has shipped 5 sprints rapidly. The critical debts (test coverage gaps and inaccessible visualizations) must be addressed before the product scales users. The high-priority debts (God components, missing DB relational links, API security) should be addressed in the next 2 sprints.

---

## 1. Complete Debt Inventory

### 1.1 CRITICAL (4 items)

| ID | Debt | Layer | Effort | Owner |
|----|------|-------|--------|-------|
| SVC-01 | Only 1 test file across 25 services (4% coverage) | Services | 40–80h | @dev |
| SVC-05 | `chartCalculation.ts` (core logic, 641L) — zero tests | Services | 8–16h | @dev |
| UX-02 | D3 visualizations completely inaccessible (WCAG Level A violations) | Frontend | 24–40h | @dev |
| DB-SD-06 | No `profile_id` FK in insights/sessions — co-mingles multi-profile data | Database | 10–16h | @dev |

### 1.2 HIGH (22 items)

| ID | Debt | Layer | Effort | Owner |
|----|------|-------|--------|-------|
| SYS-05 | No global React Error Boundary | Architecture | 3h | @dev |
| SVC-02 | `contemplation/context.ts` at 1,463L — monolithic | Services | 8–16h | @dev |
| SVC-03 | `contemplation/prompts.ts` at 1,801L — monolithic | Services | 8–16h | @dev |
| SVC-07 | Silent sync failures — no error recovery | Services | 4–8h | @dev |
| UX-01 | No global Error Boundary (same as SYS-05) | Frontend | — | merged |
| UX-03 | No `prefers-reduced-motion` support — 218 animations | Frontend | 4–6h | @dev |
| UX-04 | No skip navigation link | Frontend | 1h | @dev |
| UX-05 | Route change focus management absent | Frontend | 3–5h | @dev |
| UX-06 | `ContemplationChamber.tsx` God component (1,346L) | Frontend | 16–24h | @dev |
| UX-07 | `Profile.tsx` God component (1,202L) | Frontend | 8–14h | @dev |
| UX-11 | No geocoding — manual lat/lon entry | Frontend | 16–24h | @dev |
| UX-ADD-01 | No profile deletion confirmation | Frontend | 2h | @dev |
| DB-IDX-01 | Missing index on `saved_insights(category, type)` | Database | 1h | @dev |
| DB-IDX-02 | No full-text search on insights | Database | 2–4h | @dev |
| DB-DI-03 | Pathway timestamps lack `DEFAULT NOW()` | Database | 1h | @dev |
| DB-OPS-01 | No backup/export strategy or user data export | Database | 6–10h | @dev |
| DB-ADD-02 | `profile_data` JSONB has no schema validation | Database | 3–5h | @dev |
| GAP-02 | No rate limiting on `/api/claude` endpoint | API Security | 4–8h | @dev |
| GAP-05 | `ANTHROPIC_API_KEY` exposure risk if VITE_ prefix used | Security | 1h | @dev |
| SYS-07 | Outdated dependencies (framer-motion v10, ESLint v8) | Architecture | 8–12h | @dev |
| GAP-01 | CI/CD pipeline not audited — may lack lint/test steps | Operations | 3–5h | @devops |
| SVC-07 | No error recovery in sync — failed cloud sync is silent | Services | 4–8h | @dev |

### 1.3 MEDIUM (32 items)

| ID | Debt | Layer | Effort |
|----|------|-------|--------|
| SYS-02 | Dev/Prod AI proxy divergence (OpenRouter vs Anthropic) | Architecture | 4h |
| SYS-04 | `@` alias missing from tsconfig.json paths | Architecture | 1h |
| SYS-06 | No `.env.example` file | Architecture | 1h |
| SYS-09 | Developer profile (felipe.json) seeded into all instances | Architecture | 3h |
| SVC-04 | `profileDataParser.ts` at 770L — SRP violation | Services | 6–10h |
| SVC-06 | 4 sync services with identical pattern — abstraction candidate | Services | 4–8h |
| SVC-08 | localStorage no quota management | Services | 3–5h |
| UX-08 | Route suspense shows "Loading..." instead of skeleton | Frontend | 2h |
| UX-09 | No WCAG contrast audit | Frontend | 6–10h |
| UX-10 | Timezone list limited (~20 options) | Frontend | 3h |
| UX-12 | Home.tsx uses raw Tailwind instead of design system | Frontend | 1h |
| UX-13 | `import * as d3` — full D3 bundle | Frontend | 6–10h |
| UX-14 | 29 JSON files bundled at startup | Frontend | 12–20h |
| UX-ADD-02 | No auto-scroll to latest AI message | Frontend | 2h |
| UX-ADD-03 | No empty states for new users | Frontend | 4–6h |
| UX-ADD-05 | ProfileCreationForm — no city autocomplete | Frontend | 8–12h |
| DB-SD-01 | Missing `public.` prefix on sessions table | Database | 1h |
| DB-SD-02 | `profile_data` unversioned JSONB | Database | 3–6h |
| DB-SD-03 | `session_id` in insights — no FK | Database | 2h |
| DB-SD-04 | `focus_entity` type inconsistency TEXT vs JSONB | Database | 3h |
| DB-SD-05 | `messages` monolithic JSONB array | Database | 4–8h |
| DB-IDX-03 | No standalone `pathway_id` index | Database | 0.5h |
| DB-IDX-04 | No sessions category index | Database | 0.5h |
| DB-SEC-02 | Tags array — no validation | Database | 1h |
| DB-SEC-03 | No DB-level rate limiting | Database | 4–8h |
| DB-DI-01 | No CHECK on category/type values | Database | 2h |
| DB-AUTH-01 | Magic link only — no social login | Database | 3–4h |
| DB-OPS-02 | No Supabase CLI configuration | Database | 2h |
| DB-ADD-01 | No connection pooling documentation | Database | 2h |
| DB-ADD-03 | `journal_entries` structure undocumented | Database | 1h |
| GAP-03 | localStorage data loss risk on profile migration | Architecture | — (addressed by DB-OPS-01) |
| GAP-04 | No Content Security Policy header | Security | 2h |

### 1.4 LOW (12 items)

| ID | Debt | Layer | Effort |
|----|------|-------|--------|
| SYS-01 | Zustand dead dependency | Architecture | 0.5h |
| SYS-03 | CLAUDE.md proxy documentation mismatch | Docs | 0.5h |
| SYS-08 | vercel.json implicit api route | Architecture | 1h |
| SYS-10 | No offline/PWA strategy | Architecture | — (future) |
| SVC-09 | `neutrinoWebhook.ts` unclear purpose | Services | 1h |
| UX-15 | Dead "Coming Soon" nav items | Frontend | 1h |
| UX-16 | D3 viz fixed pixel sizes | Frontend | 6–10h |
| UX-17 | Emoji icons without aria-hidden | Frontend | 1h |
| UX-18 | Framer Motion v10 (v11 available) | Frontend | 12–20h |
| UX-ADD-04 | Cinzel font — limited Unicode/glyph support | Frontend | 2h |
| DB-SEC-01 | RLS naming inconsistency | Database | 0.5h |
| DB-AUTH-02 | No email domain allowlist | Database | 1h |

---

## 2. Final Priority Matrix

### Tier 1 — Critical Path (Must address before scale)

**Sprint K or L:**

| # | Item | Effort | Risk if Skipped |
|---|------|--------|----------------|
| 1 | Add test suite: `chartCalculation.ts` + `ephemeris.ts` | 8–16h | Core calculations regress silently |
| 2 | Add test suite: all 25 services toward 60% coverage | 40–80h | Any refactoring is dangerous |
| 3 | Add `profile_id` FK to insights + sessions | 10–16h | Multi-profile users see mixed data |
| 4 | Error Boundary in `App.tsx` | 3h | Runtime errors = blank screen |
| 5 | Rate limiting on `/api/claude` | 4–8h | Unbounded API cost exposure |

### Tier 2 — High Value (Next 2 sprints)

| # | Item | Effort | Value |
|---|------|--------|-------|
| 6 | Add indexes: insights(category,type) + full-text | 3–5h | Insight Library performance |
| 7 | Profile deletion confirmation | 2h | Prevent data loss |
| 8 | Skip navigation link | 1h | A11y quick win |
| 9 | Route focus management | 3–5h | A11y + screen reader |
| 10 | `prefers-reduced-motion` | 4–6h | A11y + user comfort |
| 11 | `ContemplationChamber.tsx` decomposition | 16–24h | AI feature velocity |
| 12 | Geocoding in ProfileCreationForm | 16–24h | Onboarding conversion |
| 13 | User data export feature | 6–10h | GDPR + data safety |
| 14 | D3 accessibility (ARIA + keyboard) | 24–40h | Legal + ethical obligation |

### Tier 3 — Architecture Health (1–3 months)

| # | Item | Effort |
|---|------|--------|
| 15 | `contemplation/context.ts` refactor | 8–16h |
| 16 | `contemplation/prompts.ts` refactor | 8–16h |
| 17 | `Profile.tsx` decomposition | 8–14h |
| 18 | D3 selective imports | 6–10h |
| 19 | JSON knowledge base lazy loading | 12–20h |
| 20 | Supabase CLI + migration tooling | 2h |
| 21 | Google OAuth | 3–4h |
| 22 | CSP headers | 2h |
| 23 | `.env.example` + documentation fixes | 2h |
| 24 | Dev/Prod proxy standardization | 4h |

---

## 3. Consolidated Effort Summary

| Priority Tier | Items | Low Estimate | High Estimate |
|--------------|-------|-------------|---------------|
| Tier 1 (Critical) | 5 | 65h | 118h |
| Tier 2 (High value) | 9 | 79h | 124h |
| Tier 3 (Architecture) | 10 | 55h | 100h |
| Remaining medium/low | 46 | ~40h | ~70h |
| **TOTAL** | **70** | **239h** | **412h** |

**Practical planning (top 23 highest-value items only):**
- Tier 1 + Tier 2 + Tier 3: **~200–340h**
- At 20h/sprint: **10–17 sprints**
- At 40h/sprint: **5–9 sprints**

---

## 4. Resolution Order

```
Sprint K — Quality Foundation:
  ├── GAP-01: Audit + fix CI/CD pipeline [@devops]
  ├── GAP-02: Rate limiting on /api/claude [@dev]
  ├── GAP-05: Document API key security [@dev, 1h]
  ├── SYS-05/UX-01: Error Boundary [@dev, 3h]
  ├── UX-04: Skip navigation [@dev, 1h]
  ├── UX-ADD-01: Profile deletion confirmation [@dev, 2h]
  ├── DB-DI-03: Pathway timestamp defaults [@dev, 1h]
  ├── DB-IDX-01: Category/type indexes [@dev, 1h]
  └── SVC-05: chartCalculation.ts tests [@dev, 8-16h]

Sprint L — Data Model + Core Tests:
  ├── DB-SD-06: profile_id FK + sync updates [@dev, 10-16h]
  ├── DB-IDX-02: Full-text search on insights [@dev, 2-4h]
  ├── DB-OPS-01: User data export + backup docs [@dev, 6-10h]
  ├── SVC-01: Expand test coverage to 60% [@dev, 20-30h]
  └── GAP-04: CSP headers [@dev, 2h]

Sprint M — Frontend Architecture:
  ├── UX-06: ContemplationChamber decomposition [@dev, 16-24h]
  ├── UX-07: Profile.tsx decomposition [@dev, 8-14h]
  ├── UX-03: prefers-reduced-motion [@dev, 4-6h]
  └── UX-ADD-03: Empty states for new users [@dev, 4-6h]

Sprint N — Onboarding + A11y:
  ├── UX-11: Geocoding in ProfileCreationForm [@dev, 16-24h]
  ├── UX-05: Route focus management [@dev, 3-5h]
  ├── UX-02: D3 visualizations accessibility [@dev, 24-40h]
  └── UX-10: Timezone comprehensive list [@dev, 3h]

Sprint O — Architecture Health:
  ├── SVC-02: contemplation/context.ts refactor [@dev]
  ├── SVC-03: contemplation/prompts.ts refactor [@dev]
  ├── UX-13: D3 selective imports [@dev]
  └── SYS-02: Dev/Prod proxy standardization [@dev]
```

---

## 5. Risks and Mitigations

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|-----------|
| Regression during refactoring without tests | HIGH | HIGH | **Must add tests before refactoring** (Sprint K SVC-05, Sprint L SVC-01) |
| User data loss (localStorage + no backup) | LOW | CRITICAL | Sprint L: data export + backup documentation |
| API cost spike from unprotected Claude endpoint | MEDIUM | HIGH | Sprint K: rate limiting |
| Multi-profile data pollution (no profile_id) | HIGH | MEDIUM | Sprint L: profile_id FK migration |
| D3 accessibility legal risk | LOW | MEDIUM | Sprint N: ARIA + keyboard nav |
| ContemplationChamber changes breaking AI | MEDIUM | HIGH | Decompose after test coverage established |

---

## 6. Criteria for Success

At the end of the remediation epic, the following must be true:

- [ ] Test coverage: ≥60% on all services (measured by Vitest coverage report)
- [ ] Zero Critical debts remaining
- [ ] Zero High debts remaining in Tier 1
- [ ] Error Boundary active — no blank screen crashes
- [ ] All D3 visualizations keyboard-navigable with ARIA labels
- [ ] `profile_id` FK active — insights/sessions filter by active profile
- [ ] User data export available in-app
- [ ] Rate limiting active on `/api/claude`
- [ ] CI/CD runs lint + test + build on every push
- [ ] `prefers-reduced-motion` honored

---

*Document Version: FINAL 1.0 — Phase 8 of 10 (Brownfield Discovery)*
*QA Gate: APPROVED (Phase 7)*
*Next: Phase 9 (@analyst — Executive Report)*
