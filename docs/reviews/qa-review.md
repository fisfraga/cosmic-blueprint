# QA Gate Review — Brownfield Discovery
**Generated by:** @qa (Quinn) — Brownfield Discovery Phase 7
**Date:** 2026-02-20
**Reviewing:** All Phase 1–6 outputs
**Verdict:** APPROVED ✅

---

## Quality Gate Checklist

| Check | Result | Notes |
|-------|--------|-------|
| All debts validated by specialists | ✅ PASS | Phases 5 + 6 complete |
| No critical gaps in coverage | ✅ PASS | See Gap Analysis below |
| Dependencies mapped | ✅ PASS | Sequencing verified |
| Risks documented | ✅ PASS | Cross-layer risks identified |
| Effort estimates validated | ✅ PASS | Specialist-revised estimates used |
| Prioritization makes sense | ✅ PASS | Quick wins separated from structural work |
| Assessment complete enough for planning | ✅ PASS | Ready for Phases 8–10 |

**QA Gate Decision: APPROVED — Proceed to Phase 8 (Final Assessment)**

---

## Gap Analysis

The following areas were checked for missing coverage:

### ✅ Covered

- Architecture (system-level debts, tech stack, deployment)
- Database (schema, indexes, security, operations, auth)
- Frontend (components, pages, design system, animations, a11y, performance)
- Services (test coverage, file sizes, patterns, error handling)
- AI system (proxy discrepancy, dev/prod divergence documented)

### ⚠️ Gaps Identified (Adding to Assessment)

---

#### GAP-01 — CI/CD Pipeline not audited
**Severity:** MEDIUM

The `.github/workflows/` directory was confirmed to exist but its contents were not examined. The CI/CD pipeline configuration is a critical part of quality assurance. Possible gaps:
- No type-check step in CI (only `npm run build` which includes `tsc`)
- No automated test step in CI
- No ESLint step in CI
- No security scanning (Dependabot, Snyk)
- No Lighthouse performance checks

**Recommendation:** Audit `.github/workflows/` contents and verify all quality checks are automated.

---

#### GAP-02 — No API security review of `/api/claude.ts`
**Severity:** HIGH

The Vercel serverless function `api/claude.ts` proxies requests to Anthropic's API. It was examined structurally but not security-audited. Possible risks:
- Is there rate limiting on the `/api/claude` endpoint? Without rate limiting, any visitor can trigger unlimited Anthropic API calls, generating unbounded cost
- Is the origin validated? Can requests from non-app domains hit this endpoint?
- Is there request size limiting? A large `systemPrompt` could cause cost spikes
- Is the API key properly protected from exposure?

**Recommendation:** Implement rate limiting on the Claude API proxy (e.g., via Vercel's request limits or middleware). Add origin validation.

---

#### GAP-03 — localStorage data persistence risk on profile migration
**Severity:** MEDIUM

`profileMigration.ts` handles v1→v2 profile format migration. But there is no documented recovery path if:
1. Migration fails mid-execution
2. A future v3 format is introduced
3. The user clears localStorage (all data lost with no backup)

The combination of no Supabase sync enforcement + no export feature + format migration risk creates a potential for total user data loss.

**Recommendation:** The data export feature (DB-OPS-01) is more urgent than its MEDIUM severity suggests when combined with the localStorage dependency.

---

#### GAP-04 — No Content Security Policy (CSP)
**Severity:** MEDIUM

The app loads content from external origins (Google Fonts, Anthropic API, Supabase) and includes inline scripts (Vite HMR in dev). No Content Security Policy header was identified in `vercel.json` or elsewhere.

**Recommendation:** Add CSP headers via `vercel.json`:
```json
{
  "headers": [{
    "source": "/(.*)",
    "headers": [{
      "key": "Content-Security-Policy",
      "value": "default-src 'self'; font-src fonts.gstatic.com; connect-src *.supabase.co openrouter.ai api.anthropic.com"
    }]
  }]
}
```

---

#### GAP-05 — `ANTHROPIC_API_KEY` scope: is it server-only?
**Severity:** HIGH

The CLAUDE.md documents `ANTHROPIC_API_KEY` as a server-side variable (Vercel env var). The vite.config dev proxy uses `OPENROUTER_API_KEY`. This separation is correct. However, if any developer accidentally adds `VITE_ANTHROPIC_API_KEY` (with VITE_ prefix), it would be exposed in the client bundle. No lint rule or documentation warns against this.

**Recommendation:** Add a comment in `.env.example` explicitly stating "NEVER prefix ANTHROPIC_API_KEY with VITE_ — it must remain server-only."

---

## Cross-Layer Risk Analysis

| Risk | Layers Affected | Probability | Impact | Mitigation |
|------|----------------|------------|--------|------------|
| Core logic regression (untested chartCalculation) | Services, All features | MEDIUM | HIGH | Add test suite (SVC-01, SVC-05) |
| User data loss (localStorage + no backup) | Services, DB | LOW | CRITICAL | Export feature + enforce cloud sync |
| API cost spike (no rate limiting on /api/claude) | API, Finance | MEDIUM | HIGH | Rate limiting (GAP-02) |
| Silent sync failures | Services, DB | MEDIUM | MEDIUM | Error recovery (SVC-07) |
| Profile data loss on accidental delete | Frontend, Services | MEDIUM | HIGH | Confirmation modal (UX-ADD-01) |
| Multi-profile data co-mingling | DB, Frontend | HIGH | MEDIUM | profile_id FK (DB-SD-06) |
| Accessibility legal risk | Frontend | LOW | MEDIUM | D3 a11y (UX-02) |
| Dev/Prod AI behavior divergence | Architecture | MEDIUM | LOW | Standardize proxy (SYS-02) |

---

## Dependency Map

The following debts must be resolved in sequence (blocker → blocked):

```
SVC-01 (add tests) → All future refactoring safely
  └── SVC-02 (context.ts refactor) — tests needed first
  └── SVC-03 (prompts.ts refactor) — tests needed first
  └── UX-06 (ContemplationChamber) — AI service tests needed first

DB-SD-06 (profile_id FK) → UX: profile-filtered Insight/Session Library
DB-IDX-02 (full-text search) → Independent, can be added anytime
DB-OPS-02 (Supabase CLI) → DB-OPS-01 (automated backup deployment)

UX-ADD-01 (delete confirmation) → Independent quick win
UX-06 (ContemplationChamber decomp) → after AI integrity protocol improvements
```

---

## Suggested Test Coverage Targets

| Service | Priority | Why |
|---------|----------|-----|
| `chartCalculation.ts` | P0 | Core business logic, untested |
| `ephemeris.ts` | P0 | Astronomical data, untested |
| `aspects.ts` | P1 | Already has 1 test file — extend |
| `profileMigration.ts` | P1 | Migration bugs cause data loss |
| `profileValidation.ts` | P1 | Validation is a safety net |
| `contemplation/context.ts` | P2 | Complex prompt building |
| All sync services | P2 | Cloud sync integrity |

**Target:** 60% line coverage on services within 2 sprints, 80% within 2 months.

---

## Quality Gate Decision

**VERDICT: APPROVED ✅**

**Rationale:**
- All 3 phases of data collection were completed and cross-validated by specialists
- All identified debts have been categorized, estimated, and prioritized
- 5 new gaps identified by QA (GAP-01 through GAP-05) have been added
- 8 additional debts discovered in specialist reviews (DB-ADD-01–03, UX-ADD-01–05)
- Dependencies are mapped and sequencing is consistent
- No blocking contradictions between specialist reviews
- Assessment is comprehensive enough to generate actionable epics and stories

**Conditions:**
- GAP-01 (CI/CD audit) should be completed at the start of the first remediation sprint
- GAP-02 (API rate limiting) should be included in the first sprint as a security item
- Data export feature priority should be elevated given GAP-03 analysis

---

*@qa (Quinn) — Phase 7 Complete*
*Proceed to Phase 8: Final Assessment (@architect)*
