# Database Specialist Review — Cosmic Blueprint
**Generated by:** @data-engineer (Dara) — Brownfield Discovery Phase 5
**Date:** 2026-02-20
**Reviewing:** `docs/prd/technical-debt-DRAFT.md` (DB section)

---

## Validation of Identified DB Debts

### Confirmed Findings

All 20 DB debts in the DRAFT are confirmed as valid. Severity adjustments below.

| ID | Original Severity | Adjusted Severity | Rationale |
|----|------------------|------------------|-----------|
| DB-SD-06 | HIGH | **CRITICAL** | For users with 2+ profiles, the absence of `profile_id` FK means the app has fundamentally broken data isolation — all insights/sessions are co-mingled across profiles. This is a product correctness issue, not just a debt. |
| DB-IDX-02 | HIGH | **HIGH** (confirmed) | Full-text search absence is acceptable for <100 insights per user. Becomes critical at 200+. |
| DB-DI-03 | HIGH | **MEDIUM** | The `pathway_progress` table is rarely written — this is low frequency. Risk is real but low probability. |
| DB-SD-05 | MEDIUM | **LOW-MEDIUM** | `messages` JSONB array is only a problem with very long conversations. Typical sessions (10–20 messages) are fine. Defer. |
| DB-DI-02 | MEDIUM | **LOW** | TEXT PKs generated by the app are functionally fine and collision-resistant given the slug strategy. UUID migration would be high effort with minimal benefit at current scale. |

---

## Additional Debts Not in DRAFT

### DB-ADD-01 — No connection pooling configuration
**Severity:** MEDIUM

Supabase uses PgBouncer for connection pooling. The app's `getSupabaseClient()` creates a singleton client but the pool mode (transaction vs session) is not documented or configured. Under high concurrency (e.g., multiple browser tabs), this could cause connection exhaustion.

**Recommendation:** Document the pool mode in Supabase dashboard and ensure the client uses the pooled connection URL for serverless contexts.

---

### DB-ADD-02 — `cosmic_profiles.profile_data` schema has no validation
**Severity:** MEDIUM

The JSONB `profile_data` column accepts any JSON. If `chartCalculation.ts` produces an incomplete or malformed profile (e.g., due to a missing ephemeris position), it gets stored without validation. There is no DB-level schema validation for the JSON structure.

**Recommendation:** Add a Supabase JSON Schema validation check or a PL/pgSQL trigger that validates minimum required fields before insert.

---

### DB-ADD-03 — `pathway_progress.journal_entries` structure is opaque
**Severity:** LOW

The `journal_entries JSONB DEFAULT '{}'` structure is not documented. The DB has no idea what shape this object takes. Any change to the journal entry schema in the app creates migration risk.

**Recommendation:** Document the expected JSON shape in a comment on the column.

---

## Corrected Estimates

| Category | Phase 2 Estimate | Revised Estimate | Notes |
|----------|-----------------|-----------------|-------|
| Schema fixes (SD-01–04) | 3–6h | 4–6h | Confirmed |
| Session messages table (SD-05) | 8–16h | 4–8h | Simpler than estimated — Supabase migration + sync service update |
| Profile ID FK + sync (SD-06) | 6–12h | **10–16h** | Requires sync service changes in all 4 sync files + profile context |
| Indexes (IDX-01–04) | 2–4h | 2–3h | Straightforward — confirmed |
| Auth (Google OAuth) | 3–6h | 3–4h | Supabase makes this easy |
| Integrity constraints | 2–3h | 2–3h | Confirmed |
| Operations (CLI, backup, export) | 4–8h | 6–10h | User data export feature takes longer |
| Additional debts (ADD-01–03) | — | 3–5h | New |
| **TOTAL** | **28–55h** | **34–55h** | Slightly higher floor |

---

## Prioritized DB Remediation Sequence

**Sequencing rationale:** Some items have dependencies. The `profile_id` FK (DB-SD-06) should come before the `session_messages` table (DB-SD-05) since both require schema migration. Index additions (IDX-01, IDX-02) are independent and can be added at any time with zero downtime.

```
Phase A (Zero-downtime, immediate wins):
  → DB-IDX-01: Add category/type indexes [1h, no app change needed]
  → DB-IDX-02: Add full-text search index [2h, no app change needed]
  → DB-IDX-03: Add pathway_id index [0.5h]
  → DB-IDX-04: Add sessions category index [0.5h]
  → DB-SD-01: Fix public. prefix [1h migration only]
  → DB-DI-03: Add DEFAULT NOW() to pathway timestamps [1h]

Phase B (Schema + sync changes, requires app update):
  → DB-SD-02: Add schema_version column [3h]
  → DB-SD-06: Add profile_id FK to insights + sessions [10-16h] ← HIGHEST VALUE
  → DB-SD-03: Add session_id FK to insights [2h]
  → DB-SD-04: Standardize focus_entity to TEXT [3h]

Phase C (Major structural changes, plan carefully):
  → DB-SD-05: Extract session_messages table [4-8h]
  → DB-OPS-02: Supabase CLI config [2h]
  → DB-OPS-01: Backup/export strategy [6-10h]

Phase D (Auth + optional enhancements):
  → DB-AUTH-01: Google OAuth [3-4h]
  → DB-SEC-02: Tags constraints [1h]
  → DB-DI-01: Category CHECK constraints [2h]
```

---

## Answers to DRAFT Questions

**Q1: Is `contemplation_sessions` actually in `public` schema?**
Yes — PostgreSQL defaults to `public` when no schema is specified. The table exists in `public.contemplation_sessions`. No functional issue, but it should be fixed for consistency in the next migration batch.

**Q2: Realistic data growth rate?**
Assuming 1 contemplation session/day and 2–5 insights saved: ~365 sessions/year, ~1,000 insights/year per user. At this rate, the missing indexes become noticeable around 500+ insights (~6 months of active use). The full-text search absence becomes user-visible sooner (100+ insights).

**Q3: Is session_messages a prerequisite?**
No — `profile_id` FK (DB-SD-06) should be done first. The messages extraction (DB-SD-05) is independent and can be deferred to a later sprint without blocking other improvements.

**Q4: Is profile_id FK the single highest-value DB improvement?**
Yes, confirmed. Without it, the Insights Library and Sessions Library show all entries regardless of active profile. For any user with multiple profiles (partner, client, child), this is a product correctness bug — not just debt.

**Q5: TEXT → UUID complexity?**
HIGH complexity, LOW value at current scale. The app generates IDs client-side using slug strategies. These are collision-resistant enough for single-user use. Recommend keeping TEXT PKs and not migrating to UUID. Mark DB-DI-02 as WONT-FIX for now.

---

## DB Specialist Sign-off

**Status:** VALIDATED ✅
**Severity adjustments:** 3 items adjusted (DB-SD-06 upgraded to CRITICAL, DB-DI-03 downgraded to MEDIUM, DB-SD-05 downgraded to LOW-MEDIUM)
**New items added:** 3 (DB-ADD-01, DB-ADD-02, DB-ADD-03)
**Revised total DB effort:** 34–55 hours

*@data-engineer (Dara) — Phase 5 Complete*
